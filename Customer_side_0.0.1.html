<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บัตรสมาชิก</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root { --primary-color: #00B900; --light-gray: #f0f2f5; --dark-gray: #666; --text-color: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; background-color: var(--light-gray); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; }
        .page-content { flex: 1; overflow-y: auto; padding: 1.5rem; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        /* Navigation */
        nav { display: flex; background-color: white; border-top: 1px solid #ddd; position: sticky; bottom: 0; }
        nav a { flex: 1; text-align: center; padding: 12px 0; color: var(--dark-gray); text-decoration: none; font-size: 0.8rem; }
        nav a.active { color: var(--primary-color); font-weight: bold; }
        nav a svg { width: 24px; height: 24px; margin-bottom: 2px; }
        /* Home Tab */
        .home-container { text-align: center; padding: 2rem 0; }
        .profile-img { border-radius: 50%; width: 100px; height: 100px; object-fit: cover; border: 3px solid var(--primary-color); }
        h1 { font-size: 1.5rem; margin: 0.5rem 0 0; }
        #qrcode-canvas { margin: 2rem auto 0; display: block; }
        /* Promotion Tab */
        .promo-card { background: white; border-radius: 12px; margin-bottom: 1rem; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .promo-card h3 { margin-top: 0; }
        .promo-card img { width: 100%; border-radius: 8px; margin-bottom: 0.5rem; }
        /* Edit Profile Tab */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .submit-btn { width: 100%; padding: 14px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        /* Status Message */
        #status-message { text-align: center; padding: 10px; border-radius: 8px; margin-top: 1rem; display: none; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <main class="page-content">
        <!-- Tab 1: Home / QR Code -->
        <div id="home" class="tab-pane active">
            <div class="home-container">
                <img id="pictureUrl" src="https://placehold.co/100x100/EFEFEF/AAAAAA?text=Profile" alt="Profile Picture" class="profile-img">
                <h1 id="displayName"></h1>
                <p id="userId"></p>
                <canvas id="qrcode-canvas"></canvas>
            </div>
        </div>

        <!-- Tab 2: Promotions -->
        <div id="promotions" class="tab-pane">
            <h2>โปรโมชั่นพิเศษ</h2>
            <div id="promo-list"></div>
        </div>

        <!-- Tab 3: Edit Profile -->
        <div id="edit" class="tab-pane">
            <h2>แก้ไขข้อมูลส่วนตัว</h2>
            <form id="edit-profile-form">
                <div class="form-group"><label for="firstName">ชื่อจริง(First Name)</label><input type="text" id="firstName"></div>
                <div class="form-group"><label for="lastName">นามสกุล(Last Name)</label><input type="text" id="lastName"></div>
                <div class="form-group"><label for="nickname">ชื่อเล่น(Nickname)</label><input type="text" id="nickname"></div>
                <div class="form-group"><label for="birthdate">วันเกิด(Date of Birth)</label><input type="date" id="birthdate"></div>
                <div class="form-group"><label for="gender">เพศ(Gender)</label><select id="gender"><option value="">เลือกเพศ (Please Choose Gender)</option><option value="Male">ชาย (Male)</option><option value="Female">หญิง (Female)</option><option value="Other">LGBTQA+</select></div>
                <div class="form-group"><label for="phoneNumber">เบอร์โทรศัพท์</label><input type="tel" id="phoneNumber"></div>
                <button type="submit" class="submit-btn">บันทึกข้อมูล</button>
            </form>
            <div id="status-message"></div>
        </div>
    </main>

    <nav>
        <a href="#home" class="nav-link active">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg>
            <div>หน้าหลัก</div>
        </a>
        <a href="#promotions" class="nav-link">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg>
            <div>โปรโมชั่น</div>
        </a>
        <a href="#edit" class="nav-link">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
            <div>แก้ไขข้อมูล</div>
        </a>
    </nav>

    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "YOUR_LIFF_ID"; // ⚠️
        const GOOGLE_SCRIPT_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL"; // ⚠️
        let USER_ID = null;

        // --- UI & NAVIGATION ---
        const navLinks = document.querySelectorAll('.nav-link');
        const tabPanes = document.querySelectorAll('.tab-pane');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);

                navLinks.forEach(l => l.classList.remove('active'));
                tabPanes.forEach(p => p.classList.remove('active'));

                link.classList.add('active');
                document.getElementById(targetId).classList.add('active');
            });
        });

        function showStatus(message, isError = false, targetElementId = 'status-message') {
            const statusEl = document.getElementById(targetElementId);
            statusEl.textContent = message;
            statusEl.className = isError ? 'status-success status-error' : 'status-success';
            statusEl.style.display = 'block';
            setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
        }

        // --- DATA FETCHING & HANDLING ---
        async function apiCall(payload) {
            // Use POST for all actions to simplify backend routing
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) throw new Error("Network response was not ok.");
            const result = await response.json();
            if (result.result === 'error') throw new Error(result.error);
            return result;
        }

        async function fetchPromotions() {
            try {
                const result = await apiCall({ action: 'getPromotions' });
                const promoList = document.getElementById('promo-list');
                promoList.innerHTML = ''; // Clear existing
                if (result.data.length === 0) {
                    promoList.innerHTML = '<p>ยังไม่มีโปรโมชั่นในขณะนี้</p>';
                    return;
                }
                result.data.forEach(promo => {
                    const card = document.createElement('div');
                    card.className = 'promo-card';
                    card.innerHTML = `
                        ${promo.ImageURL ? `<img src="${promo.ImageURL}" alt="${promo.Title}">` : ''}
                        <h3>${promo.Title}</h3>
                        <p>${promo.Description}</p>
                        <small>หมดเขต: ${new Date(promo.ExpiryDate).toLocaleDateString('th-TH')}</small>
                    `;
                    promoList.appendChild(card);
                });
            } catch (error) {
                console.error("Failed to fetch promotions:", error);
                document.getElementById('promo-list').innerHTML = '<p>ไม่สามารถโหลดโปรโมชั่นได้</p>';
            }
        }
        
        // --- INITIALIZATION ---
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                USER_ID = profile.userId;

                // Setup Home Tab
                document.getElementById('pictureUrl').src = profile.pictureUrl;
                document.getElementById('displayName').innerText = profile.displayName;
                document.getElementById('userId').innerText = `UserID: ${USER_ID}`;
                QRCode.toCanvas(document.getElementById('qrcode-canvas'), USER_ID, { width: 200 });

                // Fetch promotions for the second tab
                await fetchPromotions();

                // Setup Edit Profile Form
                document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = {
                        action: 'updateProfile',
                        userId: USER_ID,
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        nickname: document.getElementById('nickname').value,
                        birthdate: document.getElementById('birthdate').value,
                        gender: document.getElementById('gender').value,
                        phoneNumber: document.getElementById('phoneNumber').value,
                    };
                    try {
                        await apiCall(formData);
                        showStatus('บันทึกข้อมูลเรียบร้อยแล้ว!', false);
                    } catch (error) {
                        showStatus(`เกิดข้อผิดพลาด: ${error.message}`, true);
                    }
                });

            } catch (error) {
                console.error(error);
                alert("เกิดข้อผิดพลาดในการโหลดแอป: " + error.message);
            }
        }

        window.onload = main;
    </script>
</body>
</html>
