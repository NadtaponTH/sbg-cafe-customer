<script>
    // Configuration
    const CONFIG = {
        LIFF_ID: '2007836924-1X8GmJKj', // ใส่ LIFF ID ของคุณที่นี่
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzne8aEl6Zro3679P05ncik8GMhuEmMtQGdOTTF248FQjHdxSDysg1loZgqZ1sq614VUw/exec'
    };

    // Global variables
    let currentCustomer = null;
    let currentLineProfile = null;
    let playStartTime = null;
    let timerInterval = null;

    // API Helper Class (Lass's Enhanced Version)
    class APIClient {
        static async post(action, data = {}) {
            try {
                const requestBody = { action, ...data };
                console.log('API Request:', action, requestBody);

                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // Important for cross-origin requests
                    credentials: 'omit',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Use text/plain for Apps Script
                    body: JSON.stringify(requestBody),
                    redirect: 'follow'
                });

                if (!response.ok) {
                    throw new Error(`Network response error: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('API Response:', action, result);
                return result;
            } catch (error) {
                console.error('API Error:', action, error);
                throw new Error('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์');
            }
        }

        // --- Public API calls ---
        static getCustomer(lineId) {
            return this.post('getCustomer', { lineId });
        }

        static registerCustomer(customerData) {
            return this.post('registerCustomer', customerData);
        }
        
        // NEW: For customer to update their own profile
        static updateCustomerProfile(lineId, updateData) {
            return this.post('updateCustomerProfile', { lineId, updateData });
        }

        // NEW: For customer to check their own playing status
        static getActiveOrder(lineId) {
            return this.post('getActiveOrderByLineId', { lineId });
        }
    }

    // LIFF Initialization
    async function initializeLiff() {
        try {
            showLoading(true);
            await liff.init({ liffId: CONFIG.LIFF_ID });

            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            currentLineProfile = await liff.getProfile();
            console.log('LINE Profile:', currentLineProfile);

            await checkCustomerStatus(currentLineProfile.userId);

        } catch (error) {
            console.error('LIFF initialization failed:', error);
            showError('การเชื่อมต่อ LINE ล้มเหลว กรุณาลองใหม่อีกครั้ง');
            showLoading(false);
        }
    }

    // Check customer status and playing status from Backend
    async function checkCustomerStatus(lineId) {
        try {
            const result = await APIClient.getCustomer(lineId);
            
            if (result.success) {
                currentCustomer = result.customer;
                showMemberDashboard();
                await checkPlayingStatus(); // Check playing status after showing dashboard
            } else {
                showRegistrationForm();
            }
        } catch (error) {
            console.error('Error checking customer status:', error);
            showError('เกิดข้อผิดพลาดในการตรวจสอบสถานะสมาชิก');
        } finally {
            showLoading(false);
        }
    }

    // Show registration form
    function showRegistrationForm() {
        hideAllScreens();
        document.getElementById('registrationForm').classList.remove('hidden');
        if (currentLineProfile) {
            document.getElementById('nickname').value = currentLineProfile.displayName || '';
        }
    }

    // Show member dashboard and update UI
    function showMemberDashboard() {
        hideAllScreens();
        document.getElementById('memberDashboard').classList.remove('hidden');
        
        document.getElementById('memberId').textContent = currentCustomer.customerId;
        document.getElementById('memberName').textContent = currentCustomer.nickname;
        document.getElementById('memberPoints').textContent = `${currentCustomer.points || 0} แต้ม`;

        generateQRCode(currentCustomer.customerId);
        populateEditForm();
    }

    // Register new customer
    async function registerCustomer(event) {
        event.preventDefault();
        const submitBtn = document.getElementById('registerBtn');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'กำลังสมัคร...';
            clearMessages('reg');

            const formData = {
                lineId: currentLineProfile.userId,
                nickname: document.getElementById('nickname').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim() || null,
                birthday: document.getElementById('birthday').value || null
            };

            if (!formData.nickname || !formData.phone) {
                throw new Error('กรุณากรอกชื่อเล่นและเบอร์โทรศัพท์');
            }

            const result = await APIClient.registerCustomer(formData);

            if (result.success) {
                showSuccess('สมัครสมาชิกสำเร็จ!', 'reg');
                currentCustomer = {
                    customerId: result.customerId,
                    ...formData,
                    points: 0
                };
                setTimeout(() => {
                    showMemberDashboard();
                    checkPlayingStatus();
                }, 1500);
            } else {
                throw new Error(result.message || 'การสมัครสมาชิกล้มเหลว');
            }
        } catch (error) {
            console.error('Registration error:', error);
            showError(error.message, 'reg');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }

    // Update customer information
    async function updateCustomerProfile(event) {
        event.preventDefault();
        const submitBtn = document.getElementById('updateBtn');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'กำลังบันทึก...';
            clearMessages('edit');

            const updateData = {
                nickname: document.getElementById('editNickname').value.trim(),
                phone: document.getElementById('editPhone').value.trim(),
                email: document.getElementById('editEmail').value.trim() || null,
                birthday: document.getElementById('editBirthday').value || null
            };

            const result = await APIClient.updateCustomerProfile(currentLineProfile.userId, updateData);

            if (result.success) {
                showSuccess('บันทึกข้อมูลสำเร็จ!', 'edit');
                // Update local data and UI
                currentCustomer = { ...currentCustomer, ...updateData };
                document.getElementById('memberName').textContent = currentCustomer.nickname;
                setTimeout(toggleEditForm, 1500);
            } else {
                throw new Error(result.message || 'การแก้ไขข้อมูลล้มเหลว');
            }
        } catch (error) {
            console.error('Update error:', error);
            showError(error.message, 'edit');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }

    // Populate edit form with current data
    function populateEditForm() {
        if (currentCustomer) {
            document.getElementById('editNickname').value = currentCustomer.nickname;
            document.getElementById('editPhone').value = currentCustomer.phone;
            document.getElementById('editEmail').value = currentCustomer.email || '';
            document.getElementById('editBirthday').value = currentCustomer.birthday || '';
        }
    }

    // Generate QR Code
    function generateQRCode(customerId) {
        QRCode.toCanvas(document.getElementById('qrcode'), customerId, {
            width: 200,
            margin: 2,
            color: { dark: '#000000', light: '#FFFFFF' }
        }, function (error) {
            if (error) console.error('QR Code generation error:', error);
        });
    }

    // Check playing status from Backend
    async function checkPlayingStatus() {
        if (!currentCustomer) return;
        try {
            const result = await APIClient.getActiveOrder(currentCustomer.lineId);
            if (result.success && result.order) {
                playStartTime = new Date(result.order.checkInTime);
                startTimer();
            } else {
                stopTimer();
            }
        } catch (error) {
            console.error("Error checking playing status:", error);
            showError("ไม่สามารถอัปเดตสถานะการเล่นได้");
        }
    }

    // Timer functions
    function startTimer() {
        document.getElementById('timerDisplay').classList.remove('hidden');
        if (timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            if (!playStartTime) return;
            const now = new Date();
            const elapsed = now - playStartTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            const timeString = 
                hours.toString().padStart(2, '0') + ':' +
                minutes.toString().padStart(2, '0') + ':' +
                seconds.toString().padStart(2, '0');
            
            document.getElementById('playTimer').textContent = timeString;
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        document.getElementById('timerDisplay').classList.add('hidden');
        playStartTime = null;
    }

    // UI Helper functions
    function toggleEditForm() {
        const editForm = document.getElementById('editForm');
        const editBtn = document.getElementById('editBtn');
        if (editForm.classList.contains('hidden')) {
            editForm.classList.remove('hidden');
            editBtn.textContent = 'ยกเลิกการแก้ไข';
        } else {
            editForm.classList.add('hidden');
            editBtn.textContent = 'แก้ไขข้อมูลส่วนตัว';
        }
        clearMessages('edit');
    }

    async function refreshData() {
        if (currentLineProfile) {
            showLoading(true);
            await checkCustomerStatus(currentLineProfile.userId);
        }
    }

    function hideAllScreens() {
        ['loadingScreen', 'registrationForm', 'memberDashboard'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
    }

    function showLoading(show) {
        hideAllScreens();
        if (show) {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }
    }

    function showError(message, prefix = '') {
        const errorElement = document.getElementById(prefix + 'Error');
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        } else {
            alert(message); // Fallback for critical errors
        }
    }

    function showSuccess(message, prefix = '') {
        const successElement = document.getElementById(prefix + 'Success');
        if (successElement) {
            successElement.textContent = message;
            successElement.classList.remove('hidden');
            setTimeout(() => successElement.classList.add('hidden'), 3000);
        }
    }
    
    function clearMessages(prefix = '') {
        const errorElement = document.getElementById(prefix + 'Error');
        const successElement = document.getElementById(prefix + 'Success');
        if (errorElement) errorElement.classList.add('hidden');
        if (successElement) successElement.classList.add('hidden');
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('registerForm').addEventListener('submit', registerCustomer);
        // Corrected: The form submission is for the new profile update function
        document.getElementById('updateForm').addEventListener('submit', updateCustomerProfile);
    });

    // Cleanup when page unloads
    window.addEventListener('beforeunload', function() {
        if (timerInterval) clearInterval(timerInterval);
    });

    // Initialize app when page loads
    window.onload = initializeLiff;
</script>
