<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board Games Cafe - Customer</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .member-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .member-id {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }

        .member-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .qr-container {
            text-align: center;
            margin: 20px 0;
        }

        .qr-code {
            background: white;
            padding: 20px;
            border-radius: 10px;
            display: inline-block;
        }

        .timer-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            border-left: 5px solid #ee5a24;
        }

        .timer-display h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .timer {
            font-size: 36px;
            font-weight: bold;
            color: #ee5a24;
        }

        .playing-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #27ae60;
        }

        .playing-info h4 {
            color: #27ae60;
            margin-bottom: 8px;
        }

        .playing-info p {
            color: #2c3e50;
            margin: 5px 0;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }

        .edit-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .edit-form h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
            color: #666;
            border: 1px solid #dee2e6;
        }

        .debug-info h5 {
            margin: 0 0 5px 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="loading">
            <div class="loading-spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
        </div>

        <!-- Registration Form -->
        <div id="registrationForm" class="hidden">
            <div class="header">
                <h1>üé≤ Board Games Cafe</h1>
                <p>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</p>
            </div>
            <div class="content">
                <div id="regError" class="error hidden"></div>
                <div id="regSuccess" class="success hidden"></div>
                
                <!-- Debug Info -->
                <div id="regDebugInfo" class="debug-info hidden">
                    <h5>üîß Debug Information</h5>
                    <p id="regDebugText"></p>
                </div>
                
                <form id="registerForm">
                    <div class="form-group">
                        <label for="nickname">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô *</label>
                        <input type="text" id="nickname" required maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                        <input type="tel" id="phone" required maxlength="15" pattern="[0-9+\-\s()]{8,15}">
                    </div>
                    <div class="form-group">
                        <label for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                        <input type="email" id="email" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="birthday">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                        <input type="date" id="birthday">
                    </div>
                    <button type="submit" class="btn" id="registerBtn">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </form>
            </div>
        </div>

        <!-- Member Dashboard -->
        <div id="memberDashboard" class="hidden">
            <div class="header">
                <h1>üé≤ Board Games Cafe</h1>
                <p>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
            </div>
            <div class="content">
                <!-- Debug Info -->
                <div id="dashboardDebugInfo" class="debug-info hidden">
                    <h5>üîß Debug Information</h5>
                    <p id="dashboardDebugText"></p>
                </div>

                <!-- Member Card -->
                <div class="member-card">
                    <div class="member-id" id="memberId"></div>
                    <div class="member-info">
                        <span>‡∏ä‡∏∑‡πà‡∏≠:</span>
                        <span id="memberName"></span>
                    </div>
                    <div class="member-info">
                        <span>‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°:</span>
                        <span id="memberPoints">0 ‡πÅ‡∏ï‡πâ‡∏°</span>
                    </div>
                </div>

                <!-- Playing Status Info -->
                <div id="playingInfo" class="playing-info hidden">
                    <h4>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h4>
                    <p><strong>‡∏£‡∏´‡∏±‡∏™ Order:</strong> <span id="currentOrderId">-</span></p>
                    <p><strong>‡∏™‡∏≤‡∏Ç‡∏≤:</strong> <span id="currentBranch">-</span></p>
                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</strong> <span id="currentPlayerCount">-</span></p>
                </div>

                <!-- Timer Display (shown when playing) -->
                <div id="timerDisplay" class="timer-display hidden">
                    <h3>‚è∞ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô</h3>
                    <div class="timer" id="playTimer">00:00:00</div>
                    <p style="margin-top: 10px; color: #666;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: <span id="startTime">-</span></p>
                </div>

                <!-- QR Code -->
                <div class="qr-container">
                    <h3>QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Check-in/Check-out</h3>
                    <div class="qr-code">
                        <canvas id="qrcode"></canvas>
                    </div>
                </div>

                <!-- Action Buttons -->
                <button class="btn" onclick="toggleEditForm()" id="editBtn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                <button class="btn btn-secondary" onclick="refreshData()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

                <!-- Edit Form -->
                <div id="editForm" class="edit-form hidden">
                    <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                    <div id="editError" class="error hidden"></div>
                    <div id="editSuccess" class="success hidden"></div>
                    
                    <form id="updateForm">
                        <div class="form-group">
                            <label for="editNickname">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                            <input type="text" id="editNickname" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="editPhone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" id="editPhone" maxlength="15" pattern="[0-9+\-\s()]{8,15}">
                        </div>
                        <div class="form-group">
                            <label for="editEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <input type="email" id="editEmail" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="editBirthday">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                            <input type="date" id="editBirthday">
                        </div>
                        <button type="submit" class="btn" id="updateBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡πÉ‡∏´‡∏°‡πà
        const CONFIG = {
            LIFF_ID: '2007836924-1X8GmJKj',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyW1ICRMax2IEtQKDXos-kGXQtFOtqG0I_RnhPIhuxvW4mEMzkaGHdD_c4awLmXbkiPOg/exec', // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡πÉ‡∏´‡∏°‡πà
            DEBUG_MODE: true, // ‡πÄ‡∏õ‡∏¥‡∏î debug mode ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π error details
            RETRY_ATTEMPTS: 3, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
            RETRY_DELAY: 1000, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (ms)
            USE_GET_FALLBACK: true // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° GET fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CORS issues
        };

        // Global variables
        let currentCustomer = null;
        let currentLineProfile = null;
        let playStartTime = null;
        let timerInterval = null;
        let currentActiveOrder = null;

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç API Helper Class ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ CORS ‡πÅ‡∏•‡∏∞ Retry ‡∏û‡∏£‡πâ‡∏≠‡∏° GET Fallback
        class APIClient {
            static async post(action, data = {}, attempt = 1) {
                try {
                    const requestBody = { action, ...data };
                    
                    if (CONFIG.DEBUG_MODE) {
                        console.log(`üöÄ API Request (Attempt ${attempt}):`, action, requestBody);
                        showDebugInfo(`Sending: ${action} (${attempt}/${CONFIG.RETRY_ATTEMPTS})`, 'reg');
                    }

                    // ‚úÖ ‡∏•‡∏≠‡∏á POST ‡∏Å‡πà‡∏≠‡∏ô
                    const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors', 
                        cache: 'no-cache', 
                        credentials: 'omit', 
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json' 
                        },
                        redirect: 'follow', 
                        referrerPolicy: 'no-referrer', 
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (CONFIG.DEBUG_MODE) {
                        console.log('üì• API Response:', action, result);
                        showDebugInfo(`Response: ${result.success ? '‚úÖ' : '‚ùå'} ${result.message || 'OK'}`, 'dashboard');
                    }

                    return result;

                } catch (error) {
                    console.error(`‚ùå POST Error (Attempt ${attempt}):`, action, error);
                    
                    // ‚úÖ ‡∏ñ‡πâ‡∏≤ POST ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô Public Action ‡∏•‡∏≠‡∏á GET
                    if (CONFIG.USE_GET_FALLBACK && this.isPublicAction(action)) {
                        try {
                            if (CONFIG.DEBUG_MODE) {
                                showDebugInfo(`Trying GET fallback for ${action}...`, 'reg');
                            }
                            return await this.getFallback(action, data);
                        } catch (getFallbackError) {
                            console.error(`‚ùå GET Fallback also failed:`, getFallbackError);
                        }
                    }
                    
                    // ‚úÖ Retry mechanism ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö POST
                    if (attempt < CONFIG.RETRY_ATTEMPTS) {
                        if (CONFIG.DEBUG_MODE) {
                            showDebugInfo(`Retrying POST in ${CONFIG.RETRY_DELAY}ms...`, 'reg');
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
                        return this.post(action, data, attempt + 1);
                    }
                    
                    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á error ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
                    let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå';
                    
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        errorMessage = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Apps Script ‡πÑ‡∏î‡πâ - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏´‡∏£‡∏∑‡∏≠ CORS settings';
                    } else if (error.message.includes('CORS')) {
                        errorMessage = '‚ùå CORS Policy Error - Backend ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Deploy version ‡πÉ‡∏´‡∏°‡πà';
                    } else if (error.message.includes('HTTP')) {
                        errorMessage = `‚ùå Server Error: ${error.message}`;
                    }
                    
                    if (CONFIG.DEBUG_MODE) {
                        showDebugInfo(`Final Error: ${error.message}`, 'reg');
                    }
                    
                    throw new Error(errorMessage + ': ' + error.message);
                }
            }

            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Public Action ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            static isPublicAction(action) {
                const publicActions = [
                    'getCustomer', 'getBranches', 'getTickets', 'getPlayerTypes', 
                    'getActiveOrderByLineId', 'registerCustomer'
                ];
                return publicActions.includes(action);
            }

            // ‚úÖ GET Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Public Actions
            static async getFallback(action, data) {
                let url = CONFIG.APPS_SCRIPT_URL + '?action=' + action;
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° parameters ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GET
                if (action === 'getCustomer' && data.lineId) {
                    url += '&lineId=' + encodeURIComponent(data.lineId);
                } else if (action === 'getActiveOrderByLineId' && data.lineId) {
                    url += '&lineId=' + encodeURIComponent(data.lineId);
                }

                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`GET HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            }

            // ‚úÖ Public API calls ‡∏û‡∏£‡πâ‡∏≠‡∏° Enhanced Functions
            static async getCustomer(lineId) {
                return this.post('getCustomer', { lineId });
            }

            static async registerCustomer(customerData) {
                return this.post('registerCustomer', customerData);
            }

            // ‚úÖ ‡πÉ‡∏ä‡πâ Enhanced Function ‡πÉ‡∏´‡∏°‡πà
            static async updateCustomerProfile(lineId, updateData) {
                return this.post('updateCustomerProfile', { lineId, updateData });
            }

            // ‚úÖ ‡πÉ‡∏ä‡πâ Enhanced Function ‡πÉ‡∏´‡∏°‡πà
            static async getActiveOrder(lineId) {
                return this.post('getActiveOrderByLineId', { lineId });
            }
        }

        // ‚úÖ LIFF Initialization
        async function initializeLiff() {
            try {
                showLoading(true);
                
                if (CONFIG.DEBUG_MODE) {
                    showDebugInfo('Initializing LIFF...', 'reg');
                }

                await liff.init({ liffId: CONFIG.LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                currentLineProfile = await liff.getProfile();
                
                if (CONFIG.DEBUG_MODE) {
                    console.log('üë§ LINE Profile:', currentLineProfile);
                    showDebugInfo('LINE ID: ' + currentLineProfile.userId.substring(0, 10) + '...', 'reg');
                }

                await checkCustomerStatus(currentLineProfile.userId);

            } catch (error) {
                console.error('‚ùå LIFF initialization failed:', error);
                showError('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
                showLoading(false);
            }
        }

        // ‚úÖ Check customer status ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å playing status ‡∏î‡πâ‡∏ß‡∏¢
        async function checkCustomerStatus(lineId) {
            try {
                const result = await APIClient.getCustomer(lineId);

                if (result.success) {
                    // Customer exists
                    currentCustomer = result.customer;
                    showMemberDashboard();
                    
                    // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å Backend ‡∏à‡∏£‡∏¥‡∏á
                    await checkPlayingStatus();
                } else {
                    // Customer not found, show registration
                    showRegistrationForm();
                }
            } catch (error) {
                console.error('‚ùå Error checking customer status:', error);
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å Enhanced Backend
        async function checkPlayingStatus() {
            if (!currentCustomer || !currentLineProfile) return;

            try {
                if (CONFIG.DEBUG_MODE) {
                    showDebugInfo('Checking playing status...', 'dashboard');
                }

                const result = await APIClient.getActiveOrder(currentLineProfile.userId);
                
                if (result.success && result.order) {
                    // ‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà
                    currentActiveOrder = result.order;
                    playStartTime = new Date(result.order.checkInTime);
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
                    showPlayingInfo(result.order);
                    startTimer();
                    
                    if (CONFIG.DEBUG_MODE) {
                        showDebugInfo('Currently playing: Order ' + result.order.orderId, 'dashboard');
                    }
                } else {
                    // ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà
                    currentActiveOrder = null;
                    hidePlayingInfo();
                    stopTimer();
                    
                    if (CONFIG.DEBUG_MODE) {
                        showDebugInfo('Not currently playing', 'dashboard');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error checking playing status:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }

        // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
        function showPlayingInfo(order) {
            document.getElementById('currentOrderId').textContent = order.orderId;
            document.getElementById('currentBranch').textContent = order.branchId;
            document.getElementById('currentPlayerCount').textContent = order.playerCount + ' ‡∏Ñ‡∏ô';
            document.getElementById('playingInfo').classList.remove('hidden');
        }

        function hidePlayingInfo() {
            document.getElementById('playingInfo').classList.add('hidden');
        }

        // Registration function
        async function registerCustomer(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('registerBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£...';
                clearMessages('reg');

                const formData = {
                    lineId: currentLineProfile.userId,
                    nickname: document.getElementById('nickname').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    email: document.getElementById('email').value.trim() || null,
                    birthday: document.getElementById('birthday').value || null
                };

                if (!formData.nickname || !formData.phone) {
                    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå');
                }

                const result = await APIClient.registerCustomer(formData);

                if (result.success) {
                    showSuccess('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'reg');
                    
                    currentCustomer = {
                        customerId: result.customerId,
                        lineId: formData.lineId,
                        nickname: formData.nickname,
                        phone: formData.phone,
                        email: formData.email || '',
                        birthday: formData.birthday || '',
                        points: 0
                    };
                    
                    setTimeout(() => {
                        showMemberDashboard();
                        checkPlayingStatus(); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢
                    }, 1500);
                } else {
                    throw new Error(result.message || '‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }
            } catch (error) {
                console.error('‚ùå Registration error:', error);
                showError(error.message, 'reg');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // ‚úÖ Update customer profile ‡πÉ‡∏ä‡πâ Enhanced API
        async function updateCustomerProfile(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('updateBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                clearMessages('edit');

                const updateData = {
                    nickname: document.getElementById('editNickname').value.trim(),
                    phone: document.getElementById('editPhone').value.trim(),
                    email: document.getElementById('editEmail').value.trim() || null,
                    birthday: document.getElementById('editBirthday').value || null // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç field name
                };

                // ‚úÖ ‡πÉ‡∏ä‡πâ Enhanced API
                const result = await APIClient.updateCustomerProfile(currentLineProfile.userId, updateData);

                if (result.success) {
                    showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'edit');
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô currentCustomer ‡πÅ‡∏•‡∏∞ UI
                    Object.assign(currentCustomer, updateData);
                    document.getElementById('memberName').textContent = currentCustomer.nickname;
                    
                    setTimeout(() => toggleEditForm(), 1500);
                } else {
                    throw new Error(result.message || '‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }
            } catch (error) {
                console.error('‚ùå Update error:', error);
                showError(error.message, 'edit');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // UI Update Functions
        function showRegistrationForm() {
            hideAllScreens();
            document.getElementById('registrationForm').classList.remove('hidden');
            
            if (currentLineProfile) {
                document.getElementById('nickname').value = currentLineProfile.displayName || '';
            }
        }

        function showMemberDashboard() {
            hideAllScreens();
            document.getElementById('memberDashboard').classList.remove('hidden');
            
            // Update member info
            document.getElementById('memberId').textContent = currentCustomer.customerId;
            document.getElementById('memberName').textContent = currentCustomer.nickname;
            document.getElementById('memberPoints').textContent = `${currentCustomer.points || 0} ‡πÅ‡∏ï‡πâ‡∏°`;
            
            // Generate QR Code
            generateQRCode(currentCustomer.customerId);
            
            // Fill edit form with current data
            populateEditForm();
        }

        function populateEditForm() {
            if (currentCustomer) {
                document.getElementById('editNickname').value = currentCustomer.nickname;
                document.getElementById('editPhone').value = currentCustomer.phone;
                document.getElementById('editEmail').value = currentCustomer.email || '';
                document.getElementById('editBirthday').value = currentCustomer.birthday || '';
            }
        }

        function generateQRCode(customerId) {
            const canvas = document.getElementById('qrcode');
            QRCode.toCanvas(canvas, customerId, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    console.error('‚ùå QR Code generation error:', error);
                }
            });
        }

        // ‚úÖ Timer functions (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Backend)
        function startTimer() {
            document.getElementById('timerDisplay').classList.remove('hidden');
            
            if (playStartTime) {
                const startTimeStr = playStartTime.toLocaleString('th-TH');
                document.getElementById('startTime').textContent = startTimeStr;
            }
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                if (playStartTime) {
                    const now = new Date();
                    const elapsed = now - playStartTime;
                    const hours = Math.floor(elapsed / (1000 * 60 * 60));
                    const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
                    
                    const timeString = 
                        hours.toString().padStart(2, '0') + ':' +
                        minutes.toString().padStart(2, '0') + ':' +
                        seconds.toString().padStart(2, '0');
                    
                    document.getElementById('playTimer').textContent = timeString;
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timerDisplay').classList.add('hidden');
            playStartTime = null;
        }

        // UI Helper functions
        function toggleEditForm() {
            const editForm = document.getElementById('editForm');
            const editBtn = document.getElementById('editBtn');
            
            if (editForm.classList.contains('hidden')) {
                editForm.classList.remove('hidden');
                editBtn.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                clearMessages('edit');
            } else {
                editForm.classList.add('hidden');
                editBtn.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß';
                clearMessages('edit');
            }
        }

        // ‚úÖ Refresh data ‡∏à‡∏≤‡∏Å Backend
        async function refreshData() {
            if (currentLineProfile) {
                showLoading(true);
                await checkCustomerStatus(currentLineProfile.userId);
            }
        }

        function hideAllScreens() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('registrationForm').classList.add('hidden');
            document.getElementById('memberDashboard').classList.add('hidden');
        }

        function showLoading(show) {
            if (show) {
                hideAllScreens();
                document.getElementById('loadingScreen').classList.remove('hidden');
            } else {
                document.getElementById('loadingScreen').classList.add('hidden');
            }
        }

        function showError(message, prefix = '') {
            const errorElement = document.getElementById(prefix + 'Error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
                setTimeout(() => {
                    errorElement.classList.add('hidden');
                }, 8000); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏™‡∏î‡∏á error
            } else {
                alert(message);
            }
        }

        function showSuccess(message, prefix = '') {
            const successElement = document.getElementById(prefix + 'Success');
            if (successElement) {
                successElement.textContent = message;
                successElement.classList.remove('hidden');
                setTimeout(() => {
                    successElement.classList.add('hidden');
                }, 3000);
            }
        }

        function clearMessages(prefix = '') {
            const errorElement = document.getElementById(prefix + 'Error');
            const successElement = document.getElementById(prefix + 'Success');
            
            if (errorElement) errorElement.classList.add('hidden');
            if (successElement) successElement.classList.add('hidden');
        }

        // ‚úÖ Debug function
        function showDebugInfo(message, prefix = '') {
            if (!CONFIG.DEBUG_MODE) return;
            
            const debugElement = document.getElementById(prefix + 'DebugInfo');
            const debugText = document.getElementById(prefix + 'DebugText');
            
            if (debugElement && debugText) {
                debugText.textContent = new Date().toLocaleTimeString() + ': ' + message;
                debugElement.classList.remove('hidden');
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    debugElement.classList.add('hidden');
                }, 5000);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç event listener ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            document.getElementById('registerForm').addEventListener('submit', registerCustomer);
            document.getElementById('updateForm').addEventListener('submit', updateCustomerProfile);
        });

        // Listen for messages from staff app (for check-in/check-out notifications)
        window.addEventListener('message', function(event) {
            if (event.data.type === 'checkin' && currentCustomer) {
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì check-in ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                checkPlayingStatus();
            } else if (event.data.type === 'checkout') {
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì check-out ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                checkPlayingStatus();
            }
        });

        // Cleanup when page unloads
        window.addEventListener('beforeunload', function() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        });

        // ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Connection ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        async function testConnection() {
            try {
                showDebugInfo('üîç Testing connection...', 'dashboard');
                
                // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö 1: ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏á‡πà‡∏≤‡∏¢‡πÜ
                console.log('üì° Testing basic connection...');
                const testResult = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    redirect: 'follow',
                    referrerPolicy: 'no-referrer',
                    body: JSON.stringify({
                        action: 'getBranches'
                    })
                });

                console.log('üìä Response status:', testResult.status);
                console.log('üìä Response headers:', testResult.headers);

                if (testResult.ok) {
                    const result = await testResult.json();
                    showDebugInfo('‚úÖ Connection OK: ' + JSON.stringify(result).substring(0, 100), 'dashboard');
                    console.log('‚úÖ Full response:', result);
                    return true;
                } else {
                    showDebugInfo(`‚ùå HTTP ${testResult.status}: ${testResult.statusText}`, 'dashboard');
                    console.error('‚ùå Response not OK:', testResult);
                    return false;
                }
            } catch (error) {
                showDebugInfo('‚ùå Connection Error: ' + error.message, 'dashboard');
                console.error('‚ùå Full error:', error);
                
                // ‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå error type
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    console.error('üîç Analysis: CORS or Network Error');
                    showDebugInfo('üîç CORS/Network issue detected', 'dashboard');
                } else if (error.message.includes('CORS')) {
                    console.error('üîç Analysis: CORS Policy Error');
                    showDebugInfo('üîç CORS policy issue', 'dashboard');
                }
                
                return false;
            }
        }

        // ‚úÖ Initialize app when page loads
        window.onload = function() {
            if (CONFIG.DEBUG_MODE) {
                console.log('üöÄ Starting Customer LIFF App...');
                console.log('üìç Apps Script URL:', CONFIG.APPS_SCRIPT_URL);
                
                // ‚úÖ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ placeholder ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ URL ‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡πâ‡∏ß
                console.log('üîó URL is configured');
            }

            // ‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° LIFF
            testConnection().then(success => {
                if (success) {
                    console.log('‚úÖ Connection test passed, starting LIFF...');
                    initializeLiff();
                } else {
                    console.error('‚ùå Connection test failed');
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Backend ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Deploy', 'reg');
                }
            });
        };

        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Global Functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Debug
        window.testConnection = testConnection;
        window.checkPlayingStatus = checkPlayingStatus;
        window.refreshData = refreshData;
    </script>
</body>
</html>

