// --- CONFIGURATION ---
const SPREADSHEET_ID = '1ryCCn_gAHPr6UTP80F4BGh0sfSvDw1rfADn1gEPhE5E';
const MEMBERS_SHEET_NAME = 'Members';
const CHECKIN_SHEET_NAME = 'CheckInData';
const TICKET_SHEET_NAME = 'Ticket';
const STAFF_SHEET_NAME = 'Staff';

// --- COLUMN CONSTANTS ---
const MEMBERS_COLS = { USER_ID: 1, FIRST_NAME: 6, LAST_NAME: 7, NICKNAME: 8, BIRTHDATE: 9, GENDER: 10, PHONE: 12 };
const CHECKIN_COLS = { USER_ID: 2, BRANCH: 3, TABLE: 4, STATUS: 5, CHECKIN_TIME: 6, CHECKOUT_TIME: 7, DURATION: 8, TICKET_NAME: 9, PRICE: 10 };
const TICKET_COLS = { NAME: 1, PRICE: 2, DESCRIPTION: 3 };


// --- MAIN ROUTERS ---

function doGet(e) {
  try {
    const action = e.parameter.action;
    const userId = e.parameter.userId;

    switch (action) {
      case 'staffLogin':
        return handleStaffLogin({ pin: e.parameter.pin });
      case 'isMember':
        return createJsonResponse({ success: true, isMember: checkMembership(userId) });
      case 'getMemberInfo':
        return handleGetMemberInfo(userId);
      case 'getActiveSession': // Used by both Customer and Staff app now
        return handleGetActiveSession(userId, e.parameter.branch);
      case 'getTickets':
        return handleGetTickets();
      default:
        return createJsonResponse({ success: false, message: 'Invalid GET action.' });
    }
  } catch (error) {
    console.error("doGet Error: " + error.toString());
    return createJsonResponse({ success: false, message: 'An error occurred on the server: ' + error.message });
  }
}

function doPost(e) {
  try {
    const payload = JSON.parse(e.postData.contents);
    const action = payload.action;

    switch (action) {
      case 'registerMember':
        return handleRegistration(payload);
      case 'updateMemberInfo':
        return handleUpdateMember(payload);
      case 'checkIn':
        return handleCheckIn(payload);
      case 'checkOut':
        return handleCheckOut(payload);
      default:
        return createJsonResponse({ success: false, message: 'Invalid POST action.' });
    }
  } catch (error) {
    console.error("doPost Error: " + error.toString());
    return createJsonResponse({ success: false, message: 'An error occurred during the request: ' + error.message });
  }
}


// --- ACTION HANDLERS ---

function handleStaffLogin(payload) {
    const pin = payload.pin;
    if (!pin) return createJsonResponse({ success: false, message: 'PIN is required.' });
    const staffSheet = getSheet(STAFF_SHEET_NAME);
    const data = staffSheet.getRange("B2:B").getValues();
    const pins = data.flat().filter(val => val !== '').map(String);
    if (pins.includes(pin)) {
        return createJsonResponse({ success: true, message: 'Login successful!' });
    }
    return createJsonResponse({ success: false, message: 'Invalid PIN.' });
}

function handleGetMemberInfo(userId) {
    const memberInfo = getMemberDetails(userId);
    if (memberInfo) return createJsonResponse({ success: true, data: memberInfo });
    return createJsonResponse({ success: false, message: 'Member not found.' });
}

function handleGetActiveSession(userId, branch) {
    const sessionInfo = getActiveSessionDetails(userId, branch);
    if (sessionInfo) {
        return createJsonResponse({ success: true, status: 'found', data: sessionInfo });
    }
    return createJsonResponse({ success: true, status: 'not_found' });
}

function handleGetTickets() {
    const sheet = getSheet(TICKET_SHEET_NAME);
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).getValues();
    const tickets = data.map(row => ({
        name: row[TICKET_COLS.NAME - 1], price: row[TICKET_COLS.PRICE - 1], description: row[TICKET_COLS.DESCRIPTION - 1]
    }));
    return createJsonResponse({ success: true, data: tickets });
}

function handleRegistration(payload) {
    const sheet = getSheet(MEMBERS_SHEET_NAME);
    const newRow = [
      payload.userId, payload.displayName, payload.pictureUrl, new Date(), new Date(),
      '', '', payload.nickname, '', '', payload.userId, "'" + payload.tel
    ];
    sheet.appendRow(newRow);
    return createJsonResponse({ success: true, message: 'Registration successful!' });
}

function handleUpdateMember(payload) {
    const sheet = getSheet(MEMBERS_SHEET_NAME);
    const userIds = sheet.getRange("A:A").getValues().flat();
    const rowIndex = userIds.indexOf(payload.userId);
    if (rowIndex === -1) return createJsonResponse({ success: false, message: 'User to update not found.' });
    const rowToUpdate = rowIndex + 1;
    sheet.getRange(rowToUpdate, MEMBERS_COLS.FIRST_NAME).setValue(payload.firstname);
    sheet.getRange(rowToUpdate, MEMBERS_COLS.LAST_NAME).setValue(payload.lastname);
    sheet.getRange(rowToUpdate, MEMBERS_COLS.NICKNAME).setValue(payload.nickname);
    sheet.getRange(rowToUpdate, MEMBERS_COLS.BIRTHDATE).setValue(payload.birthdate);
    sheet.getRange(rowToUpdate, MEMBERS_COLS.GENDER).setValue(payload.gender);
    sheet.getRange(rowToUpdate, MEMBERS_COLS.PHONE).setValue("'" + payload.tel);
    sheet.getRange(rowToUpdate, 5).setValue(new Date());
    return createJsonResponse({ success: true, message: 'Information updated successfully!' });
}

function handleCheckIn(payload) {
    const sheet = getSheet(CHECKIN_SHEET_NAME);
    const newRow = [
        new Date(), // Timestamp
        payload.userId, payload.branch, payload.table, 'Checked-In', new Date(),
        null, null, payload.ticketName, payload.price
    ];
    sheet.appendRow(newRow);
    return createJsonResponse({ success: true, message: 'Check-in successful!' });
}

function handleCheckOut(payload) {
    const sheet = getSheet(CHECKIN_SHEET_NAME);
    const rowToUpdate = payload.rowIndex;
    if (!rowToUpdate) return createJsonResponse({ success: false, message: 'Row index not provided for checkout.' });

    const checkInTime = new Date(sheet.getRange(rowToUpdate, CHECKIN_COLS.CHECKIN_TIME).getValue());
    const checkOutTime = new Date();
    const duration = Math.round((checkOutTime - checkInTime) / (1000 * 60)); // Duration in minutes

    sheet.getRange(rowToUpdate, CHECKIN_COLS.STATUS).setValue('Checked-Out');
    sheet.getRange(rowToUpdate, CHECKIN_COLS.CHECKOUT_TIME).setValue(checkOutTime);
    sheet.getRange(rowToUpdate, CHECKIN_COLS.DURATION).setValue(duration);
    
    return createJsonResponse({ success: true, message: 'Checkout successful!' });
}


// --- HELPER FUNCTIONS ---

function getActiveSessionDetails(userId, branch) {
    const sheet = getSheet(CHECKIN_SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    for (let i = data.length - 1; i >= 1; i--) {
        const row = data[i];
        // [FIX] Trim all string values to remove accidental whitespace before comparing
        const rowUserId = (row[CHECKIN_COLS.USER_ID - 1] || '').toString().trim();
        const rowBranch = (row[CHECKIN_COLS.BRANCH - 1] || '').toString().trim();
        const rowStatus = (row[CHECKIN_COLS.STATUS - 1] || '').toString().trim();
        
        const branchMatch = branch ? rowBranch === branch.trim() : true;

        if (rowUserId === userId.trim() && branchMatch && rowStatus === 'Checked-In') {
            return {
                rowIndex: i + 1, // Return the actual row number for updates
                branch: rowBranch,
                table: row[CHECKIN_COLS.TABLE - 1],
                checkInTime: row[CHECKIN_COLS.CHECKIN_TIME - 1],
                ticketName: row[CHECKIN_COLS.TICKET_NAME - 1],
                price: row[CHECKIN_COLS.PRICE - 1]
            };
        }
    }
    return null;
}

function getMemberDetails(userId) {
  const sheet = getSheet(MEMBERS_SHEET_NAME);
  const userIds = sheet.getRange("A:A").getValues().flat();
  const rowIndex = userIds.indexOf(userId);
  if (rowIndex === -1) return null;
  
  const rowToGet = rowIndex + 1;
  const rowData = sheet.getRange(rowToGet, 1, 1, sheet.getLastColumn()).getValues()[0];
  let birthdate = rowData[MEMBERS_COLS.BIRTHDATE - 1];
  if (birthdate instanceof Date) {
      birthdate = Utilities.formatDate(birthdate, Session.getScriptTimeZone(), "yyyy-MM-dd");
  }
  return {
      firstname: rowData[MEMBERS_COLS.FIRST_NAME - 1], lastname: rowData[MEMBERS_COLS.LAST_NAME - 1],
      nickname: rowData[MEMBERS_COLS.NICKNAME - 1], birthdate: birthdate,
      gender: rowData[MEMBERS_COLS.GENDER - 1], tel: rowData[MEMBERS_COLS.PHONE - 1]
  };
}

function checkMembership(userId) {
  try {
    const sheet = getSheet(MEMBERS_SHEET_NAME);
    const userIds = sheet.getRange("A:A").getValues().flat();
    return userIds.includes(userId);
  } catch (error) { return false; }
}

function getSheet(sheetName) {
  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = spreadsheet.getSheetByName(sheetName);
  if (!sheet) {
      sheet = spreadsheet.insertSheet(sheetName);
      if (sheetName === MEMBERS_SHEET_NAME) {
          sheet.appendRow(['UserID', 'DisplayName', 'PictureURL', 'FirstSeen', 'LastUpdated', 'FirstName', 'LastName', 'NickName', 'Birthdate', 'Gender', 'LineID', 'PhoneNumber']);
      } else if (sheetName === CHECKIN_SHEET_NAME) {
          sheet.appendRow(['Timestamp', 'UserID', 'Branch', 'Table', 'Status', 'CheckInTime', 'CheckOutTime', 'DurationMinutes', 'TicketName', 'Price']);
      } else if (sheetName === TICKET_SHEET_NAME) {
          sheet.appendRow(['TicketName', 'Price', 'Description']);
      } else if (sheetName === STAFF_SHEET_NAME) {
          sheet.appendRow(['StaffName', 'PIN']);
      }
  }
  return sheet;
}

function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}
