<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siam Board Games - Staff POS</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .scanner-container { position: relative; border-radius: 12px; overflow: hidden; }
        .scanner-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }
        .scanner-corners { position: absolute; width: 40px; height: 40px; border: 3px solid #3b82f6; }
        .corner-tl { top: 20px; left: 20px; border-right: none; border-bottom: none; }
        .corner-tr { top: 20px; right: 20px; border-left: none; border-bottom: none; }
        .corner-bl { bottom: 20px; left: 20px; border-right: none; border-top: none; }
        .corner-br { bottom: 20px; right: 20px; border-left: none; border-top: none; }
        
        .receipt-style {
            font-family: 'Courier New', monospace;
            background: white;
            border: 2px dashed #ccc;
            padding: 20px;
            margin: 10px 0;
            white-space: pre-line;
        }
        
        .status-success { background-color: #d1fae5; color: #065f46; border-color: #10b981; }
        .status-error { background-color: #fee2e2; color: #991b1b; border-color: #ef4444; }
        .status-warning { background-color: #fef3c7; color: #92400e; border-color: #f59e0b; }
        
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors disabled:bg-gray-400; }
        .btn-secondary { @apply bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors; }
        .btn-success { @apply bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö POS...</p>
        </div>
    </div>

    <!-- Header -->
    <header id="header" class="bg-white shadow-sm border-b hidden">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-gray-800">üé≤ Siam Board Games</h1>
                    <span id="staff-badge" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium"></span>
                </div>
                <div id="branch-selector" class="flex items-center space-x-2">
                    <label class="text-sm text-gray-600">‡∏™‡∏≤‡∏Ç‡∏≤:</label>
                    <select id="branch-select" class="border rounded-lg px-3 py-1 text-sm">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                        <option value="Bangna">Bangna</option>
                        <option value="Ngamwongwan">Ngamwongwan</option>
                        <option value="WestGate">WestGate</option>
                        <option value="EastVille">EastVille</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="max-w-4xl mx-auto px-4 py-6">
        <!-- Status Message -->
        <div id="status-message" class="hidden p-4 rounded-lg border mb-6">
            <div class="flex items-center">
                <span id="status-icon" class="mr-2"></span>
                <span id="status-text"></span>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h2>
                <p class="text-gray-600 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ PIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™ PIN (4 ‡∏´‡∏•‡∏±‡∏Å)</label>
                    <input type="password" id="pin-input" 
                           class="w-full p-3 border border-gray-300 rounded-lg text-center text-2xl tracking-widest"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric">
                </div>
                <button type="submit" class="w-full btn-primary">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
        </div>

        <!-- Main POS Interface -->
        <div id="pos-interface" class="hidden fade-in">
            
            <!-- Customer Search Section -->
            <div id="search-section" class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                
                <!-- QR Scanner -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium text-gray-700 mb-3">‡∏™‡πÅ‡∏Å‡∏ô QR Code</h4>
                        <div id="qr-scanner" class="scanner-container bg-gray-100 aspect-square rounded-lg flex items-center justify-center">
                            <button id="start-scan-btn" class="btn-primary">
                                üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô
                            </button>
                            <div class="scanner-overlay hidden">
                                <div class="scanner-corners corner-tl"></div>
                                <div class="scanner-corners corner-tr"></div>
                                <div class="scanner-corners corner-bl"></div>
                                <div class="scanner-corners corner-br"></div>
                            </div>
                        </div>
                        <button id="stop-scan-btn" class="w-full mt-2 btn-secondary hidden">‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô</button>
                    </div>
                    
                    <!-- Manual Search -->
                    <div>
                        <h4 class="font-medium text-gray-700 mb-3">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h4>
                        <form id="manual-search-form" class="space-y-3">
                            <input type="text" id="customer-id-input" 
                                   class="w-full p-3 border border-gray-300 rounded-lg"
                                   placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 01250001)">
                            <button type="submit" class="w-full btn-primary">
                                üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                        </form>
                        
                        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600">üí° <strong>‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ:</strong> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà QR Code ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Info & Session Management -->
            <div id="customer-section" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                    <button id="back-to-search-btn" class="btn-secondary">üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
                
                <div id="customer-info" class="bg-blue-50 p-4 rounded-lg mb-4"></div>
                
                <!-- Active Session Display -->
                <div id="active-session" class="hidden">
                    <h4 class="font-semibold text-red-600 mb-3">üéÆ ‡∏°‡∏µ‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà</h4>
                    <div id="session-details" class="bg-red-50 p-4 rounded-lg mb-4"></div>
                    <button id="proceed-checkout-btn" class="btn-danger">üí∞ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Check-out</button>
                </div>
                
                <!-- New Session Setup -->
                <div id="new-session" class="hidden">
                    <h4 class="font-semibold text-green-600 mb-3">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
                    <form id="session-form" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÇ‡∏ï‡πä‡∏∞</label>
                                <input type="text" id="table-input" required
                                       class="w-full p-3 border border-gray-300 rounded-lg"
                                       placeholder="‡πÄ‡∏ä‡πà‡∏ô A1, B2, C3">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label>
                                <div class="flex items-center space-x-2">
                                    <button type="button" id="decrease-players" class="btn-secondary px-3 py-2">-</button>
                                    <input type="number" id="players-count" value="1" min="1" max="8"
                                           class="w-20 p-3 border border-gray-300 rounded-lg text-center">
                                    <button type="button" id="increase-players" class="btn-secondary px-3 py-2">+</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="setup-players-btn" class="btn-primary">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
                    </form>
                </div>
            </div>

            <!-- Players Setup -->
            <div id="players-section" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πã‡∏ß</h3>
                <div id="players-list" class="space-y-4 mb-6"></div>
                
                <!-- Debug Button - Remove this after testing -->
                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm text-yellow-700 mb-2">üîß Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°</p>
                    <button id="debug-check-btn" class="btn-secondary text-sm py-1 px-3">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                </div>
                
                <div class="flex space-x-4">
                    <button id="confirm-checkin-btn" class="flex-1 bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg opacity-50 cursor-not-allowed" disabled>
                        ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πã‡∏ß‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                    </button>
                    <button id="cancel-setup-btn" class="btn-secondary">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>

            <!-- Checkout Section -->
            <div id="checkout-section" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <div id="checkout-details" class="space-y-4 mb-6"></div>
                <form id="checkout-form" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="special-discount" value="0" min="0" step="0.5"
                                   class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                            <select id="payment-method" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="Cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                                <option value="Credit Card">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                                <option value="QR Code">QR Code</option>
                                <option value="Bank Transfer">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="checkout-notes" rows="2" 
                                  class="w-full p-3 border border-gray-300 rounded-lg"
                                  placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                    </div>
                    <button type="submit" class="w-full btn-success">üí≥ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                </form>
            </div>

            <!-- Receipt Display -->
            <div id="receipt-section" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h3>
                    <button id="print-receipt-btn" class="btn-primary">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                </div>
                <div id="receipt-content" class="receipt-style"></div>
                <div class="flex space-x-4 mt-6">
                    <button id="new-customer-btn" class="flex-1 btn-primary">üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
                    <button id="same-customer-btn" class="flex-1 btn-secondary">üîÑ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°</button>
                </div>
            </div>

        </div>
    </main>

    <!-- Print Modal -->
    <div id="print-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h3>
            <div id="printer-status" class="mb-4">
                <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå Bluetooth...</p>
            </div>
            <div id="printer-list" class="space-y-2 mb-4"></div>
            <div class="flex space-x-4">
                <button id="close-print-modal" class="flex-1 btn-secondary">‡∏õ‡∏¥‡∏î</button>
                <button id="manual-print-btn" class="flex-1 btn-primary">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbz3ZgUNsXBtldRGEOEMjFx3qBYy-3-3XYnZqDWFLr98_zmedokMKsXhdHBK6mTEFVG-1Q/exec';
        
        // Application State
        const state = {
            staff: null,
            branch: null,
            customer: null,
            session: null,
            tickets: [],
            currentPlayers: [],
            scanner: null,
            isScanning: false
        };

        // DOM Elements
        const elements = {
            loadingScreen: document.getElementById('loading-screen'),
            header: document.getElementById('header'),
            statusMessage: document.getElementById('status-message'),
            loginScreen: document.getElementById('login-screen'),
            posInterface: document.getElementById('pos-interface'),
            staffBadge: document.getElementById('staff-badge'),
            branchSelect: document.getElementById('branch-select'),
            searchSection: document.getElementById('search-section'),
            customerSection: document.getElementById('customer-section'),
            playersSection: document.getElementById('players-section'),
            checkoutSection: document.getElementById('checkout-section'),
            receiptSection: document.getElementById('receipt-section')
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTickets();
            hideLoading();
            setupEventListeners();
        });

        // API Functions
        async function apiGet(action, params = {}) {
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            Object.entries(params).forEach(([key, value]) => {
                url.searchParams.append(key, value);
            });

            const response = await fetch(url);
            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
            return await response.json();
        }

        async function apiPost(payload) {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
            return await response.json();
        }

        // Improve error handling
function improvedApiCall(apiFunction, ...args) {
    return new Promise(async (resolve, reject) => {
        try {
            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', 'info', 0);
            const result = await apiFunction(...args);
            
            if (!result || typeof result !== 'object') {
                throw new Error('Invalid response from server');
            }
            
            if (!result.success) {
                throw new Error(result.message || 'Unknown server error');
            }
            
            hideStatus();
            resolve(result);
        } catch (error) {
            console.error('API Call Error:', error);
            showStatus(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            reject(error);
        }
    });
}
        
        // Utility Functions
        function showStatus(message, type = 'info', duration = 5000) {
            const statusMessage = elements.statusMessage;
            const statusText = document.getElementById('status-text');
            const statusIcon = document.getElementById('status-icon');
            
            statusMessage.className = `p-4 rounded-lg border mb-6 status-${type}`;
            statusText.textContent = message;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            statusIcon.textContent = icons[type] || '‚ÑπÔ∏è';
            
            statusMessage.classList.remove('hidden');
            
            if (duration > 0) {
                setTimeout(() => statusMessage.classList.add('hidden'), duration);
            }
        }

        function hideLoading() {
            elements.loadingScreen.classList.add('hidden');
            elements.header.classList.remove('hidden');
        }

        function showScreen(screenName) {
            const screens = ['search-section', 'customer-section', 'players-section', 'checkout-section', 'receipt-section'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            
            // Stop QR scanner when navigating away from search
            if (state.isScanning && screenName !== 'search-section') {
                stopQRScanner();
            }
            
            if (screenName) {
                document.getElementById(screenName).classList.remove('hidden');
                
                // Reinitialize QR scanner when returning to search
                if (screenName === 'search-section') {
                    setTimeout(() => {
                        setupScannerEvents();
                    }, 100);
                }
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return hours > 0 ? `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${mins} ‡∏ô‡∏≤‡∏ó‡∏µ` : `${mins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }

        function formatTime(date) {
            return new Date(date).toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Authentication Functions
        async function handleLogin(e) {
            e.preventDefault();
            const pin = document.getElementById('pin-input').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            if (pin.length !== 4) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ PIN 4 ‡∏´‡∏•‡∏±‡∏Å', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

            try {
                const result = await apiGet('staffLogin', { pin });
                if (result.success) {
                    state.staff = result.data;
                    elements.staffBadge.textContent = `üë®‚Äçüíº ${state.staff.staffName}`;
                    elements.loginScreen.classList.add('hidden');
                    elements.posInterface.classList.remove('hidden');
                    showStatus(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${state.staff.staffName}!`, 'success');
                } else {
                    showStatus(result.message, 'error');
                }
            } catch (error) {
                showStatus(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            }
        }

        // Branch Selection
        function handleBranchChange(e) {
            state.branch = e.target.value;
            if (state.branch) {
                showStatus(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤: ${state.branch}`, 'success');
                showScreen('search-section');
            }
        }

        // Ticket Loading
        async function loadTickets() {
            try {
                const result = await apiGet('getTickets');
                if (result.success) {
                    state.tickets = result.data;
                }
            } catch (error) {
                console.error('Failed to load tickets:', error);
            }
        }

        // QR Scanner Functions
        function startQRScanner() {
            const scannerElement = document.getElementById('qr-scanner');
            const startBtn = document.getElementById('start-scan-btn');
            const stopBtn = document.getElementById('stop-scan-btn');
            
            if (state.isScanning) return;

            state.scanner = new Html5Qrcode("qr-scanner");
            
            state.scanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    stopQRScanner();
                    handleCustomerFound(decodedText, 'qr');
                },
                (errorMessage) => {
                    // Ignore scanning errors
                }
            ).then(() => {
                state.isScanning = true;
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                document.querySelector('.scanner-overlay').classList.remove('hidden');
            }).catch(err => {
                showStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï', 'error');
            });
        }

        function stopQRScanner() {
            if (state.scanner && state.isScanning) {
                state.scanner.stop().then(() => {
                    state.isScanning = false;
                    resetScannerUI();
                }).catch(err => {
                    console.error('Error stopping scanner:', err);
                    state.isScanning = false;
                    resetScannerUI();
                });
            }
        }

        function validateCheckoutButton() {
    const confirmBtn = document.getElementById('confirm-checkin-btn');
    const players = state.currentPlayers;
    
    // Check if all players have required data
    const allValid = players.every(player => {
        const ticketSelect = document.querySelector(`[data-player="${player.id}"] .ticket-select`);
        const typeSelect = document.querySelector(`[data-player="${player.id}"] .customer-type-select`);
        
        return ticketSelect && ticketSelect.value && 
               typeSelect && typeSelect.value;
    });
    
    if (allValid && players.length > 0) {
        confirmBtn.disabled = false;
        confirmBtn.className = 'flex-1 btn-primary';
        confirmBtn.textContent = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Check-in';
    } else {
        confirmBtn.disabled = true;
        confirmBtn.className = 'flex-1 bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg opacity-50 cursor-not-allowed';
        confirmBtn.textContent = '‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πã‡∏ß‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô';
    }
}
        
        function resetScannerUI() {
            const scannerContainer = document.getElementById('qr-scanner');
            scannerContainer.innerHTML = `
                <button id="start-scan-btn" class="btn-primary">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô</button>
                <div class="scanner-overlay hidden">
                    <div class="scanner-corners corner-tl"></div>
                    <div class="scanner-corners corner-tr"></div>
                    <div class="scanner-corners corner-bl"></div>
                    <div class="scanner-corners corner-br"></div>
                </div>
            `;
        }

        function setupScannerEvents() {
            const startBtn = document.getElementById('start-scan-btn');
            const stopBtn = document.getElementById('stop-scan-btn');
            
            if (startBtn) {
                startBtn.addEventListener('click', startQRScanner);
            }
            if (stopBtn) {
                stopBtn.addEventListener('click', stopQRScanner);
            }
        }

        // Customer Search Functions
        async function handleManualSearch(e) {
            e.preventDefault();
            const customerId = document.getElementById('customer-id-input').value.trim();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            if (!customerId) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', 'warning');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';

            try {
                const result = await apiGet('getMemberByCustomerId', { customerId });
                if (result.success) {
                    // IMPORTANT: Use the actual userId returned from the search
                    const actualUserId = result.data.userId;
                    console.log('Manual search found userId:', actualUserId, 'for customerId:', customerId);
                    await handleCustomerFound(actualUserId, 'manual');
                } else {
                    showStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ', 'error');
                }
            } catch (error) {
                showStatus(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
            }
        }

async function handleCustomerFound(userId, source) {
    try {
        const result = await improvedApiCall(apiGet, 'getInitialData', { userId });
        state.customer = result.data;
        
        // Ensure userId is properly stored
        if (state.customer.memberInfo) {
            state.customer.memberInfo.userId = userId;
            state.customer.userId = userId;
        } else {
            state.customer = {
                ...state.customer,
                userId: userId,
                memberInfo: null
            };
        }
        
        displayCustomerInfo();
        
        if (state.customer.activeSession) {
            displayActiveSession();
        } else {
            displayNewSessionForm();
        }
        
        showScreen('customer-section');
        
        const customerName = state.customer.memberInfo?.nickname || 'Guest';
        showStatus(`‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${customerName}`, 'success');
        
    } catch (error) {
        // Error already handled by improvedApiCall
    }
}

        
        displayCustomerInfo();
        
        if (state.customer.activeSession) {
            displayActiveSession();
        } else {
            displayNewSessionForm();
        }
        
        showScreen('customer-section');
        
        const customerName = state.customer.memberInfo?.nickname || 'Guest';
        showStatus(`‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${customerName}`, 'success');
        
    } catch (error) {
        // Error already handled by improvedApiCall
    }
}
                    
                    displayCustomerInfo();
                    
                    if (state.customer.activeSession) {
                        displayActiveSession();
                    } else {
                        displayNewSessionForm();
                    }
                    
                    showScreen('customer-section');
                    
                    const customerName = state.customer.memberInfo?.nickname || 'Guest';
                    showStatus(`‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${customerName} (UserID: ${userId})`, 'success');



