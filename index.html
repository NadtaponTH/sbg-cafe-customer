<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการร้านค้า (POS)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f4f4f8; margin: 0; padding: 1rem; color: #333; display: flex; align-items: center; justify-content: center; min-height: 100vh;}
        .container { width: 100%; max-width: 600px; margin: 1rem auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: #1a202c; }
        .section { display: none; margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #a0cfff; cursor: not-allowed; }
        button.secondary { background-color: #6c757d; }
        button.danger { background-color: #dc3545; }
        .info-box { background-color: #e9ecef; padding: 1rem; border-radius: 8px; }
        #qr-reader { border: 2px dashed #ccc; border-radius: 8px; overflow: hidden; margin-bottom: 1rem; }
        #status-message { text-align: center; padding: 1rem; border-radius: 8px; margin-top: 1rem; display: none; font-weight: 500;}
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .player-card { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ระบบจัดการร้านค้า</h1>
        
        <div id="staff-header" class="info-box hidden">
            <p><strong>พนักงาน:</strong> <span id="staff-name-display"></span> | <strong>สาขา:</strong> <span id="branch-name-display"></span></p>
        </div>

        <div id="login-section">
            <h2>พนักงานเข้าสู่ระบบ</h2>
            <form id="login-form">
                <div class="form-group"><label for="staff-pin">กรอกรหัส PIN</label><input type="password" id="staff-pin" inputmode="numeric" placeholder="****" required></div>
                <button type="submit" id="login-btn">เข้าสู่ระบบ</button>
            </form>
        </div>

        <div id="branch-section" class="section">
            <h2>กรุณาเลือกสาขา</h2>
            <div class="form-group"><label for="branch-select">สาขา</label>
                <select id="branch-select">
                    <option value="">-- เลือกสาขา --</option>
                    <option value="Bangna">Bangna</option>
                    <option value="Ngamwongwan">Ngamwongwan</option>
                    <option value="WestGate">WestGate</option>
                    <option value="EastVille">EastVille</option>
                </select>
            </div>
        </div>

        <div id="entry-section" class="section">
            <h2>ค้นหาลูกค้า / สร้างออเดอร์ใหม่</h2>
            <div id="qr-reader" style="width:100%;"></div>
            <button id="start-scan-btn">สแกน QR Code</button>
            <p style="text-align: center; margin: 1rem 0; font-weight: bold;">หรือ</p>
            <form id="manual-entry-form">
                <div class="form-group"><label for="manual-customerid">กรอกรหัสสมาชิก</label><input type="text" id="manual-customerid" placeholder="เช่น 08250001"></div>
                <button type="submit">ค้นหาลูกค้า</button>
            </form>
        </div>

        <div id="status-message"></div>
        
        <div id="order-section" class="section">
            <div id="customer-header" class="info-box mb-4"></div>
            <div class="form-group">
                <label for="table-input">ระบุโต๊ะ</label>
                <input type="text" id="table-input" required placeholder="เช่น A1, B2">
            </div>
            <div class="form-group">
                <label for="player-count-input">จำนวนผู้เล่นทั้งหมด</label>
                <div class="flex items-center">
                    <button type="button" id="decrement-players" class="secondary w-1/4">-</button>
                    <input type="number" id="player-count-input" class="text-center" value="1" min="1">
                    <button type="button" id="increment-players" class="secondary w-1/4">+</button>
                </div>
            </div>
            <button id="generate-players-btn">ยืนยันจำนวน</button>
            <div id="player-cards-container" class="mt-4"></div>
            <button id="confirm-checkin-btn" class="mt-4 hidden">ยืนยันการ Check-In</button>
        </div>
        
        <div id="checkout-section" class="section"></div>
        
        <button id="reset-btn" class="secondary" style="margin-top: 1rem; display:none;">กลับไปหน้าค้นหา</button>
    </div>

    <script>
        const MASTER_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxeGrZ_UwezhC8Qa-ekgnOf7yOJz_QMLqCdH5GzyxOSlYgonMQFw2azMVoHRDpG9s12RA/exec";
        
        let selectedBranch = null;
        let staffName = null;
        let html5QrCode = null;
        let availableTickets = [];
        let currentOrderPlayers = [];

        const allSections = document.querySelectorAll('.section');
        const loginSection = document.getElementById('login-section');
        const branchSection = document.getElementById('branch-section');
        const entrySection = document.getElementById('entry-section');
        const statusMessage = document.getElementById('status-message');
        const orderSection = document.getElementById('order-section');
        const checkoutSection = document.getElementById('checkout-section');
        const resetBtn = document.getElementById('reset-btn');

        function showStatus(message, isSuccess) {
            statusMessage.textContent = message;
            statusMessage.className = `status-${isSuccess ? 'success' : 'error'}`;
            statusMessage.style.display = 'block';
        }
        
        function hideAllSections() {
            loginSection.style.display = 'none';
            allSections.forEach(section => section.style.display = 'none');
            statusMessage.style.display = 'none';
            resetBtn.style.display = 'none';
            document.getElementById('staff-header').classList.add('hidden');
        }

        function showCustomerSearch() {
            hideAllSections();
            document.getElementById('staff-header').classList.remove('hidden');
            entrySection.style.display = 'block';
            resetBtn.style.display = 'block';
            currentOrderPlayers = [];
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop scanner", err));
            }
        }

        function resetToLogin() {
            hideAllSections();
            loginSection.style.display = 'block';
            localStorage.removeItem('selectedBranch');
            localStorage.removeItem('staffName');
        }

        async function loadTickets() {
            try {
                const response = await fetch(`${MASTER_SCRIPT_URL}?action=getTickets`);
                const result = await response.json();
                if (result.success) availableTickets = result.data;
                else throw new Error(result.message);
            } catch (error) {
                showStatus(`ไม่สามารถโหลดรายการตั๋วได้: ${error.message}`, false);
            }
        }
        
        function calculateDuration(startTime) {
            const start = new Date(startTime).getTime();
            const now = new Date().getTime();
            const diff = now - start;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            return `${hours} ชั่วโมง ${minutes} นาที`;
        }

        async function processUserId(userId) {
            if (!selectedBranch) {
                showStatus('กรุณาเลือกสาขาก่อน', false);
                return;
            }
            showStatus('กำลังตรวจสอบสถานะลูกค้า...', true);
            
            try {
                const sessionRes = await fetch(`${MASTER_SCRIPT_URL}?action=getActiveSession&userId=${userId}&branch=${selectedBranch}`);
                const sessionResult = await sessionRes.json();
                if (!sessionResult.success) throw new Error(sessionResult.message);

                if (sessionResult.status === 'found') {
                    displayCheckoutScreen(sessionResult.data);
                } else {
                    const memberRes = await fetch(`${MASTER_SCRIPT_URL}?action=getMemberInfo&userId=${userId}`);
                    const memberResult = await memberRes.json();
                    if (!memberResult.success) throw new Error(memberResult.message);
                    
                    const playerExists = currentOrderPlayers.some(p => p.userId === userId);
                    if (!playerExists) {
                        currentOrderPlayers.push({ userId: userId, ...memberResult.data });
                    }
                    displayInitialOrderScreen(currentOrderPlayers[0]);
                }
            } catch (error) {
                showStatus(`เกิดข้อผิดพลาด: ${error.message}`, false);
            }
        }

        function displayInitialOrderScreen(firstPlayer) {
            hideAllSections();
            document.getElementById('staff-header').classList.remove('hidden');
            orderSection.style.display = 'block';
            resetBtn.style.display = 'block';
            document.getElementById('customer-header').innerHTML = `
                <p><strong>ลูกค้า:</strong> ${firstPlayer.nickname} (ID: ${firstPlayer.customerId})</p>
            `;
            document.getElementById('player-count-input').value = currentOrderPlayers.length;
            document.getElementById('player-cards-container').innerHTML = '';
            document.getElementById('confirm-checkin-btn').style.display = 'none';
        }

        document.getElementById('generate-players-btn').addEventListener('click', () => {
            const playerCount = parseInt(document.getElementById('player-count-input').value, 10);
            const container = document.getElementById('player-cards-container');
            container.innerHTML = '';

            for (let i = 0; i < playerCount; i++) {
                const player = currentOrderPlayers[i] || { nickname: `ผู้เล่น ${i + 1} (Guest)`, customerId: 'N/A', userId: `GUEST_${i}` };
                const card = document.createElement('div');
                card.className = 'player-card';
                card.innerHTML = `
                    <p class="font-bold">${player.nickname}</p>
                    <div class="form-group mt-2">
                        <label for="ticket-select-${i}">เลือกตั๋ว</label>
                        <select id="ticket-select-${i}" required></select>
                    </div>
                    <div class="form-group">
                        <label for="customer-type-${i}">ประเภทลูกค้า</label>
                        <select id="customer-type-${i}" required>
                            <option value="นักศึกษา">นักศึกษา</option>
                            <option value="วัยทำงาน" selected>วัยทำงาน</option>
                            <option value="ครอบครัว">ครอบครัว</option>
                        </select>
                    </div>
                `;
                container.appendChild(card);
                
                const ticketSelect = document.getElementById(`ticket-select-${i}`);
                availableTickets.forEach(ticket => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify({ name: ticket.name, price: ticket.price });
                    option.textContent = `${ticket.name} (${ticket.price} บาท)`;
                    ticketSelect.appendChild(option);
                });
            }
            document.getElementById('confirm-checkin-btn').style.display = 'block';
        });

        document.getElementById('confirm-checkin-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const btn = e.target;
            btn.disabled = true; btn.textContent = 'กำลังบันทึก...';

            const playersData = currentOrderPlayers.map((player, index) => {
                const ticketData = JSON.parse(document.getElementById(`ticket-select-${index}`).value);
                return {
                    userId: player.userId,
                    ticketName: ticketData.name,
                    price: ticketData.price,
                    customerType: document.getElementById(`customer-type-${index}`).value
                };
            });

            const payload = {
                action: 'checkIn',
                branch: selectedBranch,
                table: document.getElementById('table-input').value,
                players: playersData
            };

            try {
                await fetch(MASTER_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                showStatus('เช็คอินกลุ่มสำเร็จ!', true);
                setTimeout(showCustomerSearch, 2000);
            } catch (error) {
                showStatus(`เกิดข้อผิดพลาด: ${error.message}`, false);
                btn.disabled = false; btn.textContent = 'ยืนยันการ Check-In';
            }
        });

        function displayCheckoutScreen(sessionData) {
            hideAllSections();
            document.getElementById('staff-header').classList.remove('hidden');
            checkoutSection.style.display = 'block';
            resetBtn.style.display = 'block';
            
            let playerHtml = '';
            sessionData.players.forEach(player => {
                playerHtml += `<p><strong>- ${player.nickname}</strong> (${player.ticketName})</p>`;
            });

            const timePlayed = calculateDuration(sessionData.players[0].checkInTime);

            checkoutSection.innerHTML = `
                <h2>สรุปยอด Check-Out</h2>
                <div class="info-box">
                    <p><strong>OrderID:</strong> ${sessionData.orderId}</p>
                    <p><strong>โต๊ะ:</strong> ${sessionData.table}</p>
                    <p><strong>เวลาที่เล่นไป:</strong> ${timePlayed}</p>
                    <h3 class="mt-2 font-bold">รายชื่อผู้เล่น:</h3>
                    ${playerHtml}
                </div>
                <form id="checkout-form" class="mt-4">
                    <div class="form-group">
                        <label for="special-discount">ส่วนลดพิเศษ (บาท)</label>
                        <input type="number" id="special-discount" value="0" min="0">
                    </div>
                    <button type="submit" class="danger">ยืนยันและคำนวณราคา</button>
                </form>
                <div id="final-price-display" class="mt-4 text-center hidden"></div>
            `;

            document.getElementById('checkout-form').addEventListener('submit', handleCheckOutSubmit);
        }
        
        async function handleCheckOutSubmit(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.textContent = 'กำลังคำนวณ...';

            const orderId = document.querySelector('#checkout-section .info-box p').textContent.split(': ')[1];
            const specialDiscount = document.getElementById('special-discount').value;

            try {
                const response = await fetch(MASTER_SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'checkOut',
                        orderId: orderId,
                        specialDiscount: specialDiscount,
                        staffId: staffName
                    })
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.message);

                const finalPriceDiv = document.getElementById('final-price-display');
                finalPriceDiv.innerHTML = `
                    <p>โปรโมชั่นที่ใช้: ${result.data.promotion}</p>
                    <h3 class="text-2xl font-bold">ยอดชำระสุทธิ: ${result.data.finalPrice.toFixed(2)} บาท</h3>
                `;
                finalPriceDiv.style.display = 'block';
                btn.style.display = 'none';
                
            } catch (error) {
                showStatus(`เกิดข้อผิดพลาด: ${error.message}`, false);
                btn.disabled = false; btn.textContent = 'ยืนยันและคำนวณราคา';
            }
        }
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pin = document.getElementById('staff-pin').value;
            const btn = document.getElementById('login-btn');
            btn.disabled = true; btn.textContent = 'กำลังตรวจสอบ...';
            try {
                const loginUrl = new URL(MASTER_SCRIPT_URL);
                loginUrl.searchParams.append('action', 'staffLogin');
                loginUrl.searchParams.append('pin', pin);
                const response = await fetch(loginUrl);
                const result = await response.json();
                if (result.success) {
                    staffName = result.staffName;
                    localStorage.setItem('staffName', staffName);
                    await loadTickets();
                    hideAllSections();
                    const savedBranch = localStorage.getItem('selectedBranch');
                    if (savedBranch) {
                        selectedBranch = savedBranch;
                        document.getElementById('branch-select').value = savedBranch;
                        document.getElementById('staff-header').classList.remove('hidden');
                        document.getElementById('staff-name-display').textContent = staffName;
                        document.getElementById('branch-name-display').textContent = selectedBranch;
                        showCustomerSearch();
                    } else {
                        branchSection.style.display = 'block';
                    }
                } else {
                    showStatus(result.message, false);
                }
            } catch (error) {
                showStatus(`เกิดข้อผิดพลาด: ${error.message}`, false);
            } finally {
                btn.disabled = false; btn.textContent = 'เข้าสู่ระบบ';
            }
        });

        document.getElementById('branch-select').addEventListener('change', () => {
            selectedBranch = document.getElementById('branch-select').value;
            if (selectedBranch) {
                localStorage.setItem('selectedBranch', selectedBranch);
                document.getElementById('staff-header').classList.remove('hidden');
                document.getElementById('staff-name-display').textContent = staffName;
                document.getElementById('branch-name-display').textContent = selectedBranch;
                showCustomerSearch();
            }
        });

        document.getElementById('add-player-btn').addEventListener('click', () => {
            hideAllSections();
            document.getElementById('staff-header').classList.remove('hidden');
            entrySection.style.display = 'block';
        });

        document.getElementById('start-scan-btn').addEventListener('click', () => {
            html5QrCode = new Html5Qrcode("qr-reader");
            const onScanSuccess = (decodedText) => {
                if (html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => processUserId(decodedText));
                }
            };
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess)
                .catch(err => console.error("QR scanner failed to start.", err));
        });

        document.getElementById('manual-entry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerId = document.getElementById('manual-customerid').value;
            if (!customerId) return;
            showStatus('กำลังค้นหา User ID...', true);
            try {
                const url = new URL(MASTER_SCRIPT_URL);
                url.searchParams.append('action', 'getUserIdByCustomerId');
                url.searchParams.append('customerId', customerId);
                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    processUserId(result.userId);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showStatus(`เกิดข้อผิดพลาด: ${error.message}`, false);
            }
        });
        
        document.getElementById('decrement-players').addEventListener('click', () => {
            const input = document.getElementById('player-count-input');
            let count = parseInt(input.value, 10);
            if (count > 1) input.value = count - 1;
        });

        document.getElementById('increment-players').addEventListener('click', () => {
            const input = document.getElementById('player-count-input');
            input.value = parseInt(input.value, 10) + 1;
        });

        resetBtn.addEventListener('click', showCustomerSearch);
        
        resetToLogin();
    </script>
</body>
</html>
