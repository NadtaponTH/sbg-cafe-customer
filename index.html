<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการร้านค้า (POS)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f4f8; margin: 0; padding: 1rem; color: #333; display: flex; align-items: center; justify-content: center; min-height: 100vh;}
        .container { width: 100%; max-width: 600px; margin: 1rem auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: #1a202c; }
        .section { display: none; margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #a0cfff; cursor: not-allowed; }
        button.secondary { background-color: #6c757d; }
        button.danger { background-color: #dc3545; }
        .info-box { background-color: #e9ecef; padding: 1rem; border-radius: 8px; }
        #qr-reader { border: 2px dashed #ccc; border-radius: 8px; overflow: hidden; margin-bottom: 1rem; }
        #status-message { text-align: center; padding: 1rem; border-radius: 8px; margin-top: 1rem; display: none; font-weight: 500;}
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .player-card { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .player-count-control { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .player-count-control input { text-align: center; }
        .player-count-control button { width: 4rem; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ระบบจัดการร้านค้า</h1>
        
        <div id="staff-header" class="info-box hidden">
            <p><strong>พนักงาน:</strong> <span id="staff-name-display"></span> | <strong>สาขา:</strong> <span id="branch-name-display"></span></p>
        </div>

        <div id="login-section">
            <h2>พนักงานเข้าสู่ระบบ</h2>
            <form id="login-form">
                <div class="form-group"><label for="staff-pin">กรอกรหัส PIN</label><input type="password" id="staff-pin" inputmode="numeric" placeholder="****" required></div>
                <button type="submit" id="login-btn">เข้าสู่ระบบ</button>
            </form>
        </div>

        <div id="branch-section" class="section">
            <h2>กรุณาเลือกสาขา</h2>
            <div class="form-group"><label for="branch-select">สาขา</label>
                <select id="branch-select">
                    <option value="">-- เลือกสาขา --</option>
                    <option value="Bangna">Bangna</option>
                    <option value="Ngamwongwan">Ngamwongwan</option>
                    <option value="WestGate">WestGate</option>
                    <option value="EastVille">EastVille</option>
                </select>
            </div>
        </div>

        <div id="entry-section" class="section">
            <h2>ค้นหาลูกค้า / สร้างออเดอร์ใหม่</h2>
            <div id="qr-reader" style="width:100%;"></div>
            <button id="start-scan-btn">สแกน QR Code</button>
            <p style="text-align: center; margin: 1rem 0; font-weight: bold;">หรือ</p>
            <form id="manual-entry-form">
                <div class="form-group"><label for="manual-customerid">กรอกรหัสสมาชิก</label><input type="text" id="manual-customerid" placeholder="เช่น 08250001"></div>
                <button type="submit">ค้นหาลูกค้า</button>
            </form>
        </div>

        <div id="status-message"></div>
        
        <div id="order-section" class="section">
            <h3>ข้อมูลออเดอร์</h3>
            <div id="customer-header" class="info-box mb-4"></div>
            <div class="form-group">
                <label for="table-input">ระบุโต๊ะ</label>
                <input type="text" id="table-input" required placeholder="เช่น A1, B2">
            </div>
            <div class="form-group">
                <label for="player-count-input">จำนวนผู้เล่นทั้งหมด</label>
                <div class="player-count-control">
                    <button type="button" id="decrement-players" class="secondary">-</button>
                    <input type="number" id="player-count-input" value="1" min="1">
                    <button type="button" id="increment-players" class="secondary">+</button>
                </div>
            </div>
            <button id="generate-players-btn">ยืนยันจำนวน</button>
            <div id="player-cards-container" class="mt-4"></div>
            <button id="confirm-checkin-btn" class="mt-4 hidden">ยืนยันการ Check-In ทั้งหมด</button>
        </div>
        
        <div id="checkout-section" class="section"></div>

        <div id="checkin-summary-section" class="section">
            <h2>เช็คอินสำเร็จ!</h2>
            <div id="summary-details" class="info-box"></div>
            <button id="summary-done-btn" class="mt-4">เสร็จสิ้น</button>
        </div>
        
        <button id="reset-btn" class="secondary" style="margin-top: 1rem; display:none;">กลับไปหน้าค้นหา</button>
    </div>

    <script>
        const MASTER_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1PHIzqBlXxSEk-5U8RwrFSMVmfmtk8-kt99B5WmeY4pqr8utS9C3MGWceZ1iuF5EJxw/exec";
        
        let state = {
            selectedBranch: null,
            staffName: null,
            availableTickets: [],
            currentOrder: [],
        };
        
        let html5QrCode = null;

        const ui = {
            staffHeader: document.getElementById('staff-header'),
            staffNameDisplay: document.getElementById('staff-name-display'),
            branchNameDisplay: document.getElementById('branch-name-display'),
            loginSection: document.getElementById('login-section'),
            branchSection: document.getElementById('branch-section'),
            entrySection: document.getElementById('entry-section'),
            orderSection: document.getElementById('order-section'),
            checkoutSection: document.getElementById('checkout-section'),
            checkinSummarySection: document.getElementById('checkin-summary-section'),
            statusMessage: document.getElementById('status-message'),
            resetBtn: document.getElementById('reset-btn'),
            customerHeader: document.getElementById('customer-header'),
            tableInput: document.getElementById('table-input'),
            playerCountInput: document.getElementById('player-count-input'),
            generatePlayersBtn: document.getElementById('generate-players-btn'),
            playerCardsContainer: document.getElementById('player-cards-container'),
            confirmCheckinBtn: document.getElementById('confirm-checkin-btn'),
            summaryDetails: document.getElementById('summary-details'),
            summaryDoneBtn: document.getElementById('summary-done-btn'),
        };

        function showScreen(screen) {
            document.querySelectorAll('.section, #login-section').forEach(s => s.style.display = 'none');
            ui.statusMessage.style.display = 'none';
            ui.resetBtn.style.display = 'none';
            ui.staffHeader.classList.add('hidden');

            if (screen !== 'login') {
                ui.staffHeader.classList.remove('hidden');
            }

            switch(screen) {
                case 'login': ui.loginSection.style.display = 'block'; break;
                case 'branch': ui.branchSection.style.display = 'block'; break;
                case 'entry': ui.entrySection.style.display = 'block'; ui.resetBtn.style.display = 'block'; break;
                case 'order': ui.orderSection.style.display = 'block'; ui.resetBtn.style.display = 'block'; break;
                case 'checkout': ui.checkoutSection.style.display = 'block'; ui.resetBtn.style.display = 'block'; break;
                case 'checkin-summary': ui.checkinSummarySection.style.display = 'block'; break;
            }
        }

        async function apiGet(action, params = {}) {
            const url = new URL(MASTER_SCRIPT_URL);
            url.searchParams.append('action', action);
            for (const key in params) {
                url.searchParams.append(key, params[key]);
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            return result.data;
        }

        async function apiPost(payload) {
            const response = await fetch(MASTER_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            return result;
        }

        async function handleLogin(e) {
            e.preventDefault();
            const pin = document.getElementById('staff-pin').value;
            const btn = document.getElementById('login-btn');
            btn.disabled = true; btn.textContent = 'กำลังตรวจสอบ...';
            try {
                const data = await apiGet('staffLogin', { pin });
                state.staffName = data.staffName;
                localStorage.setItem('staffName', state.staffName);
                await loadTickets();
                
                const savedBranch = localStorage.getItem('selectedBranch');
                if (savedBranch) {
                    state.selectedBranch = savedBranch;
                    document.getElementById('branch-select').value = savedBranch;
                    ui.staffNameDisplay.textContent = state.staffName;
                    ui.branchNameDisplay.textContent = state.selectedBranch;
                    showScreen('entry');
                } else {
                    showScreen('branch');
                }
            } catch (error) {
                ui.statusMessage.textContent = error.message;
                ui.statusMessage.className = 'status-error';
                ui.statusMessage.style.display = 'block';
            } finally {
                btn.disabled = false; btn.textContent = 'เข้าสู่ระบบ';
            }
        }

        async function loadTickets() {
            try {
                state.availableTickets = await apiGet('getTickets');
            } catch (error) {
                showStatus(`ไม่สามารถโหลดรายการตั๋วได้: ${error.message}`, false);
            }
        }

        async function processUserId(userId) {
            ui.statusMessage.style.display = 'block';
            ui.statusMessage.textContent = 'กำลังตรวจสอบสถานะลูกค้า...';
            ui.statusMessage.className = 'status-success';

            try {
                const sessionData = await apiGet('getActiveSession', { userId, branch: state.selectedBranch });
                if (sessionData) {
                    displayCheckoutScreen(sessionData);
                } else {
                    const memberData = await apiGet('getMemberInfo', { userId });
                    const playerExists = state.currentOrder.some(p => p.userId === userId);
                    if (!playerExists) {
                        state.currentOrder.push({ userId, ...memberData });
                    }
                    displayInitialOrderScreen(state.currentOrder[0]);
                }
            } catch (error) {
                ui.statusMessage.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
                ui.statusMessage.className = 'status-error';
            }
        }

        function displayInitialOrderScreen(firstPlayer) {
            showScreen('order');
            ui.customerHeader.innerHTML = `<p><strong>ลูกค้า:</strong> ${firstPlayer.nickname} (ID: ${firstPlayer.customerId})</p>`;
            ui.playerCountInput.value = state.currentOrder.length;
            ui.playerCardsContainer.innerHTML = '';
            ui.confirmCheckinBtn.style.display = 'none';
        }

        function generatePlayerCards() {
            const playerCount = parseInt(ui.playerCountInput.value, 10);
            ui.playerCardsContainer.innerHTML = '';

            for (let i = 0; i < playerCount; i++) {
                const player = state.currentOrder[i] || { nickname: `ผู้เล่น ${i + 1} (Guest)`, customerId: 'N/A', userId: `GUEST_${i}` };
                const card = document.createElement('div');
                card.className = 'player-card';
                card.innerHTML = `
                    <p class="font-bold">${player.nickname} <span class="text-gray-500 text-sm">(ID: ${player.customerId})</span></p>
                    <div class="form-group mt-2">
                        <label for="ticket-select-${i}">เลือกตั๋ว</label>
                        <select id="ticket-select-${i}" required></select>
                    </div>
                    <div class="form-group">
                        <label for="customer-type-${i}">ประเภทลูกค้า</label>
                        <select id="customer-type-${i}" required>
                            <option value="นักศึกษา">นักศึกษา</option>
                            <option value="วัยทำงาน" selected>วัยทำงาน</option>
                            <option value="ครอบครัว">ครอบครัว</option>
                        </select>
                    </div>
                `;
                ui.playerCardsContainer.appendChild(card);
                
                const ticketSelect = document.getElementById(`ticket-select-${i}`);
                state.availableTickets.forEach(ticket => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify({ name: ticket.name, price: ticket.price });
                    option.textContent = `${ticket.name} (${ticket.price} บาท)`;
                    ticketSelect.appendChild(option);
                });
            }
            ui.confirmCheckinBtn.style.display = 'block';
        }
        
        async function handleCheckInSubmit(e) {
            e.preventDefault();
            ui.confirmCheckinBtn.disabled = true;
            ui.confirmCheckinBtn.textContent = 'กำลังบันทึก...';

            try {
                const playersData = Array.from({ length: parseInt(ui.playerCountInput.value, 10) }).map((_, i) => {
                    const playerInfo = state.currentOrder[i] || { userId: `GUEST_${i+1}` };
                    const ticketData = JSON.parse(document.getElementById(`ticket-select-${i}`).value);
                    return {
                        userId: playerInfo.userId,
                        ticketName: ticketData.name,
                        price: ticketData.price,
                        customerType: document.getElementById(`customer-type-${i}`).value
                    };
                });

                const payload = {
                    action: 'checkIn',
                    branch: state.selectedBranch,
                    table: ui.tableInput.value,
                    players: playersData
                };

                const result = await apiPost(payload);
                displayCheckinSummary(result.orderId, ui.tableInput.value, playersData.length);

            } catch (error) {
                showStatus(`เช็คอินไม่สำเร็จ: ${error.message}`, false);
            } finally {
                ui.confirmCheckinBtn.disabled = false;
                ui.confirmCheckinBtn.textContent = 'ยืนยันการ Check-In ทั้งหมด';
            }
        }
        
        function displayCheckinSummary(orderId, table, playerCount) {
            showScreen('checkin-summary');
            ui.summaryDetails.innerHTML = `
                <p><strong>OrderID:</strong> ${orderId}</p>
                <p><strong>โต๊ะ:</strong> ${table}</p>
                <p><strong>จำนวนผู้เล่น:</strong> ${playerCount} คน</p>
                <p><strong>เวลาเช็คอิน:</strong> ${new Date().toLocaleTimeString('th-TH')}</p>
            `;
        }

        function showCustomerSearch() {
            showScreen('entry');
            state.currentOrder = [];
        }

        // --- Event Listeners ---
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('branch-select').addEventListener('change', (e) => {
            state.selectedBranch = e.target.value;
            if (state.selectedBranch) {
                localStorage.setItem('selectedBranch', state.selectedBranch);
                ui.staffNameDisplay.textContent = state.staffName;
                ui.branchNameDisplay.textContent = state.selectedBranch;
                showScreen('entry');
            }
        });
        document.getElementById('start-scan-btn').addEventListener('click', () => {
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    if (html5QrCode.isScanning) {
                        html5QrCode.stop().then(() => processUserId(decodedText));
                    }
                },
                (errorMessage) => {}
            ).catch(err => showStatus("ไม่สามารถเปิดกล้องได้", false));
        });

        document.getElementById('manual-entry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerId = document.getElementById('manual-customerid').value;
            if (!customerId) return;
            
            showStatus('กำลังค้นหาลูกค้า...', true); // [FIX] Added user feedback
            try {
                const data = await apiGet('getUserIdByCustomerId', { customerId });
                if (data && data.userId) {
                    processUserId(data.userId);
                } else {
                    throw new Error('Could not retrieve a valid User ID for that Customer ID.');
                }
            } catch (error) {
                showStatus(`เกิดข้อผิดพลาด: ${error.message}`, false);
            }
        });

        document.getElementById('decrement-players').addEventListener('click', () => {
            const input = ui.playerCountInput;
            let count = parseInt(input.value, 10);
            if (count > 1) input.value = count - 1;
        });
        document.getElementById('increment-players').addEventListener('click', () => {
            const input = ui.playerCountInput;
            input.value = parseInt(input.value, 10) + 1;
        });
        ui.generatePlayersBtn.addEventListener('click', generatePlayerCards);
        ui.confirmCheckinBtn.addEventListener('click', handleCheckInSubmit);
        ui.resetBtn.addEventListener('click', showCustomerSearch);
        ui.summaryDoneBtn.addEventListener('click', showCustomerSearch);

        showScreen('login');
    </script>
</body>
</html>
