<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการร้านค้า (POS)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f4f4f8; margin: 0; padding: 1rem; color: #333; display: flex; align-items: center; justify-content: center; min-height: 100vh;}
        .container { width: 100%; max-width: 600px; margin: 1rem auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: #1a202c; }
        .section { display: none; margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #a0cfff; cursor: not-allowed; }
        button.secondary { background-color: #6c757d; }
        button.danger { background-color: #dc3545; }
        .info-box { background-color: #e9ecef; padding: 1rem; border-radius: 8px; }
        #qr-reader { border: 2px dashed #ccc; border-radius: 8px; overflow: hidden; margin-bottom: 1rem; }
        #status-message { text-align: center; padding: 1rem; border-radius: 8px; margin-top: 1rem; display: none; font-weight: 500;}
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .player-card { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; }
    </style>
</head>

<body>
    
    <div class="container">
        <h1>ระบบจัดการร้านค้า</h1>

        <div id="login-section">
            <h2>พนักงานเข้าสู่ระบบ</h2>
            <form id="login-form">
                <div class="form-group"><label for="staff-pin">กรอกรหัส PIN</label><input type="password" id="staff-pin" inputmode="numeric" placeholder="****" required></div>
                <button type="submit" id="login-btn">เข้าสู่ระบบ</button>
            </form>
        </div>

        <div id="branch-section" class="section">
            <h2>กรุณาเลือกสาขา</h2>
            <div class="form-group"><label for="branch-select">สาขา</label>
                <select id="branch-select">
                    <option value="">-- เลือกสาขา --</option>
                    <option value="Bangna">Bangna</option>
                    <option value="Ngamwongwan">Ngamwongwan</option>
                    <option value="WestGate">WestGate</option>
                    <option value="EastVille">EastVille</option>
                </select>
            </div>
        </div>

        <div id="entry-section" class="section">

            <h2>ค้นหาลูกค้า / สร้างออเดอร์ใหม่</h2>

            <div id="qr-reader" style="width:100%;"></div>
            <button id="start-scan-btn">สแกน QR Code</button>
            <p style="text-align: center; margin: 1rem 0; font-weight: bold;">หรือ</p>
            <form id="manual-entry-form">
                <div class="form-group"><label for="manual-customerid">กรอกรหัสสมาชิก</label><input type="text" id="manual-customerid" placeholder="เช่น 08250001"></div>
                <button type="submit">ค้นหาลูกค้า</button>
            </form>
        </div>

        <div id="status-message"></div>

        <div id="order-section" class="section">
            <h2 id="order-header">สร้างออเดอร์ใหม่</h2>
            <div id="player-list" class="space-y-2 mb-4"></div>
            <button id="add-player-btn" class="secondary mb-4">เพิ่มผู้เล่น</button>
            <form id="order-details-form">
                <div class="form-group"><label for="table-select">ระบุโต๊ะ</label><input type="text" id="table-select" required placeholder="เช่น A1, B2"></div>
                <button type="submit" id="confirm-checkin-btn">ยืนยันการ Check-In</button>
            </form>
        </div>
        <div id="checkout-section" class="section"></div>
        <button id="reset-btn" class="secondary" style="margin-top: 1rem; display:none;">กลับไปหน้าค้นหา</button>
    </div>

<script>
    // --- 1. CONFIGURATION & STATE ---
    const CONFIG = {
        scriptURL: "https://script.google.com/macros/s/AKfycbw3tDYOtGY7tRr0vysDWZ2tY2Ka7HfQW1G23dpuklbXIBfSvdjpFtVd2eAugS2gdxGnyw/exec"
    };

    // Refactored: Centralized state management
    const state = {
        staffPin: null,
        selectedBranch: null,
        availableTickets: [],
        currentOrder: [], // Array of player objects {userId, customerId, nickname, ...}
    };

    // --- 2. UI ELEMENT CACHE ---
    // Refactored: Cached all DOM elements for performance and cleaner code
    const ui = {
        container: document.querySelector('.container'),
        login: {
            section: document.getElementById('login-section'),
            form: document.getElementById('login-form'),
            pinInput: document.getElementById('staff-pin'),
            button: document.getElementById('login-btn')
        },
        branch: {
            section: document.getElementById('branch-section'),
            select: document.getElementById('branch-select')
        },
        entry: {
            section: document.getElementById('entry-section'),
            qrReader: document.getElementById('qr-reader'),
            startScanBtn: document.getElementById('start-scan-btn'),
            manualForm: document.getElementById('manual-entry-form'),
            manualInput: document.getElementById('manual-customerid')
        },
        order: {
            section: document.getElementById('order-section'),
            playerList: document.getElementById('player-list'),
            addPlayerBtn: document.getElementById('add-player-btn'),
            form: document.getElementById('order-details-form'),
            tableInput: document.getElementById('table-select'),
            submitBtn: document.getElementById('confirm-checkin-btn')
        },
        checkout: {
            section: document.getElementById('checkout-section')
        },
        statusMessage: document.getElementById('status-message'),
        resetBtn: document.getElementById('reset-btn'),
        logoutBtn: document.getElementById('logout-btn') // Make sure to add this button in HTML
    };

    let html5QrCode = null;

    // --- 3. API HELPERS ---
    // Refactored: Centralized API call logic for consistency and error handling
    const api = {
        async get(action, params = {}) {
            const url = new URL(CONFIG.scriptURL);
            url.searchParams.append('action', action);
            for (const key in params) {
                url.searchParams.append(key, params[key]);
            }
            const response = await fetch(url);
            const result = await response.json();
            if (!result.success) throw new Error(result.message || 'Unknown API error');
            return result.data;
        },
        async post(payload) {
            // Changed: Removed 'mode: no-cors' - This is the most critical fix.
            const response = await fetch(CONFIG.scriptURL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Google Apps Script quirk
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.message || 'Unknown API error');
            return result;
        }
    };

    // --- 4. UI MANAGEMENT ---
    function showStatus(message, isSuccess = true) {
        ui.statusMessage.textContent = message;
        ui.statusMessage.className = isSuccess ? 'status-success' : 'status-error';
        ui.statusMessage.style.display = 'block';
    }

    function hideStatus() {
        ui.statusMessage.style.display = 'none';
    }

    // Refactored: A single function to control which screen is visible
    function showScreen(screenName) {
        // Hide everything first
        Object.values(ui).forEach(el => {
            if (el.section) el.section.style.display = 'none';
        });
        ui.resetBtn.style.display = 'none';
        ui.logoutBtn.style.display = 'none';
        hideStatus();

        // Stop scanner if it's running and we're leaving the entry screen
        if (screenName !== 'entry' && html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.error("Failed to stop scanner", err));
        }

        switch (screenName) {
            case 'login':
                ui.login.section.style.display = 'block';
                break;
            case 'branch':
                ui.branch.section.style.display = 'block';
                ui.logoutBtn.style.display = 'block';
                break;
            case 'entry':
                state.currentOrder = []; // Reset order when showing the entry screen
                ui.entry.section.style.display = 'block';
                ui.resetBtn.style.display = 'none'; // No need for reset here
                ui.logoutBtn.style.display = 'block';
                break;
            case 'order':
                ui.order.section.style.display = 'block';
                ui.resetBtn.style.display = 'block';
                ui.logoutBtn.style.display = 'block';
                renderOrderList();
                break;
            case 'checkout':
                ui.checkout.section.style.display = 'block';
                ui.resetBtn.style.display = 'block';
                ui.logoutBtn.style.display = 'block';
                break;
        }
    }

    // --- 5. UI RENDERING ---
    function renderOrderList() {
        ui.order.playerList.innerHTML = '';
        if (state.currentOrder.length === 0) {
            ui.order.playerList.innerHTML = `<p class="text-center text-gray-500">Scan or enter customer ID to add a player.</p>`;
            return;
        }

        state.currentOrder.forEach((player, index) => {
            const card = document.createElement('div');
            card.className = 'player-card';
            
            let ticketOptions = state.availableTickets.map(ticket =>
                `<option value='${JSON.stringify({ name: ticket.name, price: ticket.price })}'>
                    ${ticket.name} (${ticket.price} บาท)
                </option>`
            ).join('');

            card.innerHTML = `
                <p><strong>รหัสสมาชิก:</strong> ${player.customerId || 'N/A'}</p>
                <p><strong>ชื่อเล่น:</strong> ${player.nickname || 'N/A'}</p>
                <div class="form-group mt-2">
                    <label for="ticket-select-${index}">เลือกตั๋ว</label>
                    <select id="ticket-select-${index}" required>${ticketOptions}</select>
                </div>
                <div class="form-group">
                    <label for="customer-type-${index}">ประเภทลูกค้า</label>
                    <select id="customer-type-${index}" required>
                        <option value="นักศึกษา">นักศึกษา</option>
                        <option value="วัยทำงาน" selected>วัยทำงาน</option>
                        <option value="ครอบครัว">ครอบครัว</option>
                    </select>
                </div>`;
            ui.order.playerList.appendChild(card);
        });
    }

    function renderCheckoutScreen(sessionData) {
        const timePlayed = (() => {
            const start = new Date(sessionData.checkInTime).getTime();
            const now = new Date().getTime();
            const diff = now - start;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            return `${hours} ชั่วโมง ${minutes} นาที`;
        })();

        ui.checkout.section.innerHTML = `
            <h2>สรุปยอด Check-Out</h2>
            <div class="info-box">
                <p><strong>OrderID:</strong> ${sessionData.orderId}</p>
                <p><strong>โต๊ะ:</strong> ${sessionData.table}</p>
                <p><strong>เวลาที่เล่นไป:</strong> ${timePlayed}</p>
                <p><strong>ราคาเต็ม:</strong> ${sessionData.totalPrice} บาท</p>
            </div>
            <form id="checkout-form" class="mt-4">
                <div class="form-group">
                    <label for="voucher-code">รหัส Voucher (ถ้ามี)</label>
                    <input type="text" id="voucher-code">
                </div>
                 <div class="form-group">
                    <label for="special-discount">ส่วนลดพิเศษ (บาท)</label>
                    <input type="number" id="special-discount" value="0" min="0">
                </div>
                <button type="submit" class="danger">ยืนยันและคำนวณราคา</button>
            </form>
            <div id="final-price-display" class="mt-4 text-center" style="display:none;"></div>`;
        
        document.getElementById('checkout-form').addEventListener('submit', (e) => handleCheckoutSubmit(e, sessionData));
        showScreen('checkout');
    }

    // --- 6. CORE LOGIC & EVENT HANDLERS ---
    async function handleLogin(e) {
        e.preventDefault();
        const pin = ui.login.pinInput.value;
        ui.login.button.disabled = true;
        ui.login.button.textContent = 'กำลังตรวจสอบ...';
        try {
            await api.get('staffLogin', { pin });
            state.staffPin = pin;
            await loadInitialData(); // Load tickets after successful login
            
            const savedBranch = localStorage.getItem('selectedBranch');
            if (savedBranch) {
                state.selectedBranch = savedBranch;
                ui.branch.select.value = savedBranch;
                showScreen('entry');
            } else {
                showScreen('branch');
            }
        } catch (error) {
            showStatus(error.message, false);
        } finally {
            ui.login.button.disabled = false;
            ui.login.button.textContent = 'เข้าสู่ระบบ';
        }
    }

    async function loadInitialData() {
        try {
            state.availableTickets = await api.get('getTickets');
        } catch (error) {
            showStatus(`ไม่สามารถโหลดรายการตั๋วได้: ${error.message}`, false);
        }
    }

    function handleBranchSelect(e) {
        state.selectedBranch = e.target.value;
        if (state.selectedBranch) {
            localStorage.setItem('selectedBranch', state.selectedBranch);
            showScreen('entry');
        }
    }

    async function processUser(identifier, type = 'userId') {
        if (!state.selectedBranch) {
            showStatus('กรุณาเลือกสาขาก่อน', false);
            return;
        }
        showStatus('กำลังตรวจสอบข้อมูลลูกค้า...', true);
        
        try {
            let userId = identifier;
            if (type === 'customerId') {
                const data = await api.get('getUserIdByCustomerId', { customerId: identifier });
                userId = data.userId;
            }

            // Refactored: Use the more efficient getUserInitialData endpoint
            const data = await api.get('getUserInitialData', { userId });

            if (data.activeSession) {
                // User is already checked-in, show checkout screen
                renderCheckoutScreen(data.activeSession);
            } else {
                // User is not checked-in, add to order
                const playerExists = state.currentOrder.some(p => p.userId === userId);
                if (!playerExists) {
                    state.currentOrder.push({ userId, ...data.memberInfo });
                } else {
                    showStatus('ผู้เล่นคนนี้อยู่ในออเดอร์แล้ว', false);
                }
                showScreen('order');
            }
        } catch (error) {
            showStatus(`เกิดข้อผิดพลาด: ${error.message}`, false);
            showScreen('entry'); // Go back to entry screen on error
        }
    }

    async function handleCheckInSubmit(e) {
        e.preventDefault();
        ui.order.submitBtn.disabled = true;
        ui.order.submitBtn.textContent = 'กำลังบันทึก...';

        try {
            const playersData = state.currentOrder.map((player, index) => {
                const ticketData = JSON.parse(document.getElementById(`ticket-select-${index}`).value);
                return {
                    userId: player.userId,
                    ticketName: ticketData.name,
                    price: ticketData.price,
                    customerType: document.getElementById(`customer-type-${index}`).value
                };
            });
            
            const payload = {
                action: 'checkIn',
                branch: state.selectedBranch,
                table: ui.order.tableInput.value,
                players: playersData,
                staffId: state.staffPin // Include staff PIN for logging
            };

            // CRITICAL FIX: Properly await the POST request and check the response.
            const result = await api.post(payload);
            
            showStatus(`เช็คอินสำเร็จ! Order ID: ${result.orderId}`, true);
            setTimeout(() => showScreen('entry'), 2500);

        } catch (error) {
            showStatus(`เช็คอินไม่สำเร็จ: ${error.message}`, false);
            ui.order.submitBtn.disabled = false;
            ui.order.submitBtn.textContent = 'ยืนยันการ Check-In';
        }
    }

    // Placeholder for checkout logic
    async function handleCheckoutSubmit(e, sessionData) {
        e.preventDefault();
        showStatus('ฟังก์ชัน Check-out ยังไม่เสร็จสมบูรณ์', false);
        // This is where you would call the `checkOut` API endpoint
    }

    function handleLogout() {
        state.staffPin = null;
        state.selectedBranch = null;
        localStorage.removeItem('selectedBranch');
        ui.login.pinInput.value = '';
        showScreen('login');
    }
    
    // --- 7. INITIALIZATION ---
    function initialize() {
        // Attach all event listeners
        ui.login.form.addEventListener('submit', handleLogin);
        ui.branch.select.addEventListener('change', handleBranchSelect);
        ui.entry.manualForm.addEventListener('submit', (e) => {
            e.preventDefault();
            processUser(ui.entry.manualInput.value, 'customerId');
        });
        ui.entry.startScanBtn.addEventListener('click', () => {
            html5QrCode = new Html5Qrcode("qr-reader");
            const onScanSuccess = (decodedText) => {
                if (html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => processUser(decodedText, 'userId'));
                }
            };
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess)
                .catch(err => showStatus("ไม่สามารถเปิดกล้องได้", false));
        });
        ui.order.addPlayerBtn.addEventListener('click', () => showScreen('entry'));
        ui.order.form.addEventListener('submit', handleCheckInSubmit);
        ui.resetBtn.addEventListener('click', () => showScreen('entry'));
        ui.logoutBtn.addEventListener('click', handleLogout);

        showScreen('login'); // Start at the login screen
    }

    initialize();
</script>


